{"version":3,"sources":["../../src/helpers/superagentLike.js"],"sourcesContent":["import stream from 'node:stream';\n\nexport function isJSON(mime) {\n    // should match /json or +json\n    // but not /json-seq\n    return /[/+]json($|[^-\\w])/i.test(mime);\n}\n\nconst parseType = (string_) => string_.split(/ *; */).shift();\n\nconst parseTypeParams = (value) => {\n    const object = {};\n    for (const string_ of value.split(/ *; */)) {\n        const parts = string_.split(/ *= */);\n        const key = parts.shift();\n        const value = parts.shift();\n\n        if (key && value) object[key] = value;\n    }\n\n    return object;\n};\n\nclass ResponseWrapper {\n    static async create_(request, response) {\n        const wrapper = new ResponseWrapper(request, response);\n        await wrapper.parseBody_();\n        return wrapper;\n    }\n\n    constructor(request, response) {\n        this.req = request;\n        this.res = response;\n        this.headers = this.header = {};\n\n        this._setStatusProperties();\n        this._setHeaders();\n    }\n\n    async parseBody_() {\n        console.log(this.type, this.status);\n        if (isJSON(this.type)) {\n            this.body = await this.res.json();\n        } else if (this.type.startsWith('text/')) {\n            this.body = await this.res.text();\n            console.log(this.body);\n        } else {            \n            this.body = this.res.body;            \n        }\n\n        if (this.error) {\n            throw this.error;\n        }\n    }\n\n    get(field) {\n        return this.header[field.toLowerCase()];\n    }\n\n    _setHeaders() {\n        for (const [key, value] of this.res.headers) {\n            this.header[key.toLowerCase()] = value;\n        }\n\n        // content-type\n        const ct = this.header['content-type'] || '';\n        this.type = parseType(ct);\n\n        // params\n        const parameters = parseTypeParams(ct);\n        Object.assign(this, parameters);\n    }\n\n    _setStatusProperties() {\n        const status = this.res.status;\n        const type = Math.trunc(status / 100);\n\n        // status / class\n        this.status = this.statusCode = status;\n        this.statusType = type;\n        this.statusText = this.res.statusText;\n\n        // basics\n        this.info = type === 1;\n        this.ok = type === 2;\n        this.redirect = type === 3;\n        this.clientError = type === 4;\n        this.serverError = type === 5;\n        this.error = type === 4 || type === 5 ? this.toError() : false;\n\n        // sugar\n        this.created = status === 201;\n        this.accepted = status === 202;\n        this.noContent = status === 204;\n        this.badRequest = status === 400;\n        this.unauthorized = status === 401;\n        this.notAcceptable = status === 406;\n        this.forbidden = status === 403;\n        this.notFound = status === 404;\n        this.unprocessableEntity = status === 422;\n    }\n\n    toError() {\n        const { url, method } = this.req;\n\n        const message = `cannot ${method} ${url} (${this.status})`;\n        const error = new Error(message);\n        error.status = this.status;\n        error.method = method;\n        error.url = url;\n\n        return error;\n    }\n}\n\nexport default ResponseWrapper;\n"],"names":["isJSON","mime","test","parseType","string_","split","shift","parseTypeParams","value","object","parts","key","ResponseWrapper","create_","request","response","wrapper","parseBody_","console","log","type","status","body","res","json","startsWith","text","error","get","field","header","toLowerCase","_setHeaders","headers","ct","parameters","Object","assign","_setStatusProperties","Math","trunc","statusCode","statusType","statusText","info","ok","redirect","clientError","serverError","toError","created","accepted","noContent","badRequest","unauthorized","notAcceptable","forbidden","notFound","unprocessableEntity","url","method","req","message","Error","constructor"],"mappings":";;;;;;;;;;;IAEgBA,MAAM;eAANA;;IAiHhB,OAA+B;eAA/B;;;mEAnHmB;;;;;;AAEZ,SAASA,OAAOC,IAAI,EAAE;IACzB,8BAA8B;IAC9B,oBAAoB;IACpB,OAAO,sBAAsBC,IAAI,CAACD;AACtC;AAEA,MAAME,YAAY,CAACC,UAAYA,QAAQC,KAAK,CAAC,SAASC,KAAK;AAE3D,MAAMC,kBAAkB,CAACC,QAAU;IAC/B,MAAMC,SAAS,CAAC;IAChB,KAAK,MAAML,WAAWI,MAAMH,KAAK,CAAC,SAAU;QACxC,MAAMK,QAAQN,QAAQC,KAAK,CAAC;QAC5B,MAAMM,MAAMD,MAAMJ,KAAK;QACvB,MAAME,QAAQE,MAAMJ,KAAK;QAEzB,IAAIK,OAAOH,OAAOC,MAAM,CAACE,IAAI,GAAGH;IACpC;IAEA,OAAOC;AACX;AAEA,MAAMG;IACF,aAAaC,QAAQC,OAAO,EAAEC,QAAQ,EAAE;QACpC,MAAMC,UAAU,IAAIJ,gBAAgBE,SAASC;QAC7C,MAAMC,QAAQC,UAAU;QACxB,OAAOD;IACX;IAWA,MAAMC,aAAa;QACfC,QAAQC,GAAG,CAAC,IAAI,CAACC,IAAI,EAAE,IAAI,CAACC,MAAM;QAClC,IAAIrB,OAAO,IAAI,CAACoB,IAAI,GAAG;YACnB,IAAI,CAACE,IAAI,GAAG,MAAM,IAAI,CAACC,GAAG,CAACC,IAAI;QACnC,OAAO,IAAI,IAAI,CAACJ,IAAI,CAACK,UAAU,CAAC,UAAU;YACtC,IAAI,CAACH,IAAI,GAAG,MAAM,IAAI,CAACC,GAAG,CAACG,IAAI;YAC/BR,QAAQC,GAAG,CAAC,IAAI,CAACG,IAAI;QACzB,OAAO;YACH,IAAI,CAACA,IAAI,GAAG,IAAI,CAACC,GAAG,CAACD,IAAI;QAC7B,CAAC;QAED,IAAI,IAAI,CAACK,KAAK,EAAE;YACZ,MAAM,IAAI,CAACA,KAAK,CAAC;QACrB,CAAC;IACL;IAEAC,IAAIC,KAAK,EAAE;QACP,OAAO,IAAI,CAACC,MAAM,CAACD,MAAME,WAAW,GAAG;IAC3C;IAEAC,cAAc;QACV,KAAK,MAAM,CAACrB,KAAKH,MAAM,IAAI,IAAI,CAACe,GAAG,CAACU,OAAO,CAAE;YACzC,IAAI,CAACH,MAAM,CAACnB,IAAIoB,WAAW,GAAG,GAAGvB;QACrC;QAEA,eAAe;QACf,MAAM0B,KAAK,IAAI,CAACJ,MAAM,CAAC,eAAe,IAAI;QAC1C,IAAI,CAACV,IAAI,GAAGjB,UAAU+B;QAEtB,SAAS;QACT,MAAMC,aAAa5B,gBAAgB2B;QACnCE,OAAOC,MAAM,CAAC,IAAI,EAAEF;IACxB;IAEAG,uBAAuB;QACnB,MAAMjB,SAAS,IAAI,CAACE,GAAG,CAACF,MAAM;QAC9B,MAAMD,OAAOmB,KAAKC,KAAK,CAACnB,SAAS;QAEjC,iBAAiB;QACjB,IAAI,CAACA,MAAM,GAAG,IAAI,CAACoB,UAAU,GAAGpB;QAChC,IAAI,CAACqB,UAAU,GAAGtB;QAClB,IAAI,CAACuB,UAAU,GAAG,IAAI,CAACpB,GAAG,CAACoB,UAAU;QAErC,SAAS;QACT,IAAI,CAACC,IAAI,GAAGxB,SAAS;QACrB,IAAI,CAACyB,EAAE,GAAGzB,SAAS;QACnB,IAAI,CAAC0B,QAAQ,GAAG1B,SAAS;QACzB,IAAI,CAAC2B,WAAW,GAAG3B,SAAS;QAC5B,IAAI,CAAC4B,WAAW,GAAG5B,SAAS;QAC5B,IAAI,CAACO,KAAK,GAAGP,SAAS,KAAKA,SAAS,IAAI,IAAI,CAAC6B,OAAO,KAAK,KAAK;QAE9D,QAAQ;QACR,IAAI,CAACC,OAAO,GAAG7B,WAAW;QAC1B,IAAI,CAAC8B,QAAQ,GAAG9B,WAAW;QAC3B,IAAI,CAAC+B,SAAS,GAAG/B,WAAW;QAC5B,IAAI,CAACgC,UAAU,GAAGhC,WAAW;QAC7B,IAAI,CAACiC,YAAY,GAAGjC,WAAW;QAC/B,IAAI,CAACkC,aAAa,GAAGlC,WAAW;QAChC,IAAI,CAACmC,SAAS,GAAGnC,WAAW;QAC5B,IAAI,CAACoC,QAAQ,GAAGpC,WAAW;QAC3B,IAAI,CAACqC,mBAAmB,GAAGrC,WAAW;IAC1C;IAEA4B,UAAU;QACN,MAAM,EAAEU,IAAG,EAAEC,OAAM,EAAE,GAAG,IAAI,CAACC,GAAG;QAEhC,MAAMC,UAAU,CAAC,OAAO,EAAEF,OAAO,CAAC,EAAED,IAAI,EAAE,EAAE,IAAI,CAACtC,MAAM,CAAC,CAAC,CAAC;QAC1D,MAAMM,QAAQ,IAAIoC,MAAMD;QACxBnC,MAAMN,MAAM,GAAG,IAAI,CAACA,MAAM;QAC1BM,MAAMiC,MAAM,GAAGA;QACfjC,MAAMgC,GAAG,GAAGA;QAEZ,OAAOhC;IACX;IAlFAqC,YAAYlD,OAAO,EAAEC,QAAQ,CAAE;QAC3B,IAAI,CAAC8C,GAAG,GAAG/C;QACX,IAAI,CAACS,GAAG,GAAGR;QACX,IAAI,CAACkB,OAAO,GAAG,IAAI,CAACH,MAAM,GAAG,CAAC;QAE9B,IAAI,CAACQ,oBAAoB;QACzB,IAAI,CAACN,WAAW;IACpB;AA4EJ;MAEA,WAAepB"}