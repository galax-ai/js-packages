{"version":3,"sources":["../../src/helpers/superagentLike.js"],"sourcesContent":["export function isJSON(mime) {\n    // should match /json or +json\n    // but not /json-seq\n    return /[/+]json($|[^-\\w])/i.test(mime);\n}\n\nconst parseType = (string_) => string_.split(/ *; */).shift();\n\nconst parseTypeParams = (value) => {\n    const object = {};\n    for (const string_ of value.split(/ *; */)) {\n        const parts = string_.split(/ *= */);\n        const key = parts.shift();\n        const value = parts.shift();\n\n        if (key && value) object[key] = value;\n    }\n\n    return object;\n};\n\nclass ResponseWrapper {\n    static async create_(request, response) {\n        const wrapper = new ResponseWrapper(request, response);\n        await wrapper.parseBody_();\n        return wrapper;\n    }\n\n    constructor(request, response) {\n        this.req = request;\n        this.res = response;\n        this.headers = this.header = {};\n\n        this._setStatusProperties();\n        this._setHeaders();\n    }\n\n    async parseBody_() {\n        console.log(this.type, this.status);\n        if (isJSON(this.type)) {\n            this.body = await this.res.json();\n        } else if (this.type.startsWith('text/')) {\n            this.text = await this.res.text();\n            if (this.error) {\n                this.error.text = this.text;\n            }\n            console.log(this.body);\n        } else {            \n            this.body = this.res.body;            \n        }\n\n        if (this.error) {\n            const _error = new Error(this.statusText);\n            _error.response = this;\n            throw _error;\n        }\n    }\n\n    get(field) {\n        return this.header[field.toLowerCase()];\n    }\n\n    _setHeaders() {\n        for (const [key, value] of this.res.headers) {\n            this.header[key.toLowerCase()] = value;\n        }\n\n        // content-type\n        const ct = this.header['content-type'] || '';\n        this.type = parseType(ct);\n\n        // params\n        const parameters = parseTypeParams(ct);\n        Object.assign(this, parameters);\n    }\n\n    _setStatusProperties() {\n        const status = this.res.status;\n        const type = Math.trunc(status / 100);\n\n        // status / class\n        this.status = this.statusCode = status;\n        this.statusType = type;\n        this.statusText = this.res.statusText;\n\n        // basics\n        this.info = type === 1;\n        this.ok = type === 2;\n        this.redirect = type === 3;\n        this.clientError = type === 4;\n        this.serverError = type === 5;\n        this.error = type === 4 || type === 5 ? this.toError() : false;\n\n        // sugar\n        this.created = status === 201;\n        this.accepted = status === 202;\n        this.noContent = status === 204;\n        this.badRequest = status === 400;\n        this.unauthorized = status === 401;\n        this.notAcceptable = status === 406;\n        this.forbidden = status === 403;\n        this.notFound = status === 404;\n        this.unprocessableEntity = status === 422;\n    }\n\n    toError() {\n        const { url, method } = this.req;\n\n        const _url = new URL(url);\n        const __url = _url.pathname;\n        const message = `cannot ${method} ${__url} (${this.status})`;\n        const error = new Error(message);   \n        error.status = this.status;\n        error.method = method;\n        error.url = __url;\n\n        return error;\n    }\n}\n\nexport default ResponseWrapper;\n"],"names":["isJSON","mime","test","parseType","string_","split","shift","parseTypeParams","value","object","parts","key","ResponseWrapper","create_","request","response","wrapper","parseBody_","console","log","type","status","body","res","json","startsWith","text","error","_error","Error","statusText","get","field","header","toLowerCase","_setHeaders","headers","ct","parameters","Object","assign","_setStatusProperties","Math","trunc","statusCode","statusType","info","ok","redirect","clientError","serverError","toError","created","accepted","noContent","badRequest","unauthorized","notAcceptable","forbidden","notFound","unprocessableEntity","url","method","req","_url","URL","__url","pathname","message","constructor"],"mappings":";;;;;;;;;;;IAAgBA,MAAM;eAANA;;IAwHhB,OAA+B;eAA/B;;;AAxHO,SAASA,OAAOC,IAAI,EAAE;IACzB,8BAA8B;IAC9B,oBAAoB;IACpB,OAAO,sBAAsBC,IAAI,CAACD;AACtC;AAEA,MAAME,YAAY,CAACC,UAAYA,QAAQC,KAAK,CAAC,SAASC,KAAK;AAE3D,MAAMC,kBAAkB,CAACC,QAAU;IAC/B,MAAMC,SAAS,CAAC;IAChB,KAAK,MAAML,WAAWI,MAAMH,KAAK,CAAC,SAAU;QACxC,MAAMK,QAAQN,QAAQC,KAAK,CAAC;QAC5B,MAAMM,MAAMD,MAAMJ,KAAK;QACvB,MAAME,QAAQE,MAAMJ,KAAK;QAEzB,IAAIK,OAAOH,OAAOC,MAAM,CAACE,IAAI,GAAGH;IACpC;IAEA,OAAOC;AACX;AAEA,MAAMG;IACF,aAAaC,QAAQC,OAAO,EAAEC,QAAQ,EAAE;QACpC,MAAMC,UAAU,IAAIJ,gBAAgBE,SAASC;QAC7C,MAAMC,QAAQC,UAAU;QACxB,OAAOD;IACX;IAWA,MAAMC,aAAa;QACfC,QAAQC,GAAG,CAAC,IAAI,CAACC,IAAI,EAAE,IAAI,CAACC,MAAM;QAClC,IAAIrB,OAAO,IAAI,CAACoB,IAAI,GAAG;YACnB,IAAI,CAACE,IAAI,GAAG,MAAM,IAAI,CAACC,GAAG,CAACC,IAAI;QACnC,OAAO,IAAI,IAAI,CAACJ,IAAI,CAACK,UAAU,CAAC,UAAU;YACtC,IAAI,CAACC,IAAI,GAAG,MAAM,IAAI,CAACH,GAAG,CAACG,IAAI;YAC/B,IAAI,IAAI,CAACC,KAAK,EAAE;gBACZ,IAAI,CAACA,KAAK,CAACD,IAAI,GAAG,IAAI,CAACA,IAAI;YAC/B,CAAC;YACDR,QAAQC,GAAG,CAAC,IAAI,CAACG,IAAI;QACzB,OAAO;YACH,IAAI,CAACA,IAAI,GAAG,IAAI,CAACC,GAAG,CAACD,IAAI;QAC7B,CAAC;QAED,IAAI,IAAI,CAACK,KAAK,EAAE;YACZ,MAAMC,SAAS,IAAIC,MAAM,IAAI,CAACC,UAAU;YACxCF,OAAOb,QAAQ,GAAG,IAAI;YACtB,MAAMa,OAAO;QACjB,CAAC;IACL;IAEAG,IAAIC,KAAK,EAAE;QACP,OAAO,IAAI,CAACC,MAAM,CAACD,MAAME,WAAW,GAAG;IAC3C;IAEAC,cAAc;QACV,KAAK,MAAM,CAACxB,KAAKH,MAAM,IAAI,IAAI,CAACe,GAAG,CAACa,OAAO,CAAE;YACzC,IAAI,CAACH,MAAM,CAACtB,IAAIuB,WAAW,GAAG,GAAG1B;QACrC;QAEA,eAAe;QACf,MAAM6B,KAAK,IAAI,CAACJ,MAAM,CAAC,eAAe,IAAI;QAC1C,IAAI,CAACb,IAAI,GAAGjB,UAAUkC;QAEtB,SAAS;QACT,MAAMC,aAAa/B,gBAAgB8B;QACnCE,OAAOC,MAAM,CAAC,IAAI,EAAEF;IACxB;IAEAG,uBAAuB;QACnB,MAAMpB,SAAS,IAAI,CAACE,GAAG,CAACF,MAAM;QAC9B,MAAMD,OAAOsB,KAAKC,KAAK,CAACtB,SAAS;QAEjC,iBAAiB;QACjB,IAAI,CAACA,MAAM,GAAG,IAAI,CAACuB,UAAU,GAAGvB;QAChC,IAAI,CAACwB,UAAU,GAAGzB;QAClB,IAAI,CAACU,UAAU,GAAG,IAAI,CAACP,GAAG,CAACO,UAAU;QAErC,SAAS;QACT,IAAI,CAACgB,IAAI,GAAG1B,SAAS;QACrB,IAAI,CAAC2B,EAAE,GAAG3B,SAAS;QACnB,IAAI,CAAC4B,QAAQ,GAAG5B,SAAS;QACzB,IAAI,CAAC6B,WAAW,GAAG7B,SAAS;QAC5B,IAAI,CAAC8B,WAAW,GAAG9B,SAAS;QAC5B,IAAI,CAACO,KAAK,GAAGP,SAAS,KAAKA,SAAS,IAAI,IAAI,CAAC+B,OAAO,KAAK,KAAK;QAE9D,QAAQ;QACR,IAAI,CAACC,OAAO,GAAG/B,WAAW;QAC1B,IAAI,CAACgC,QAAQ,GAAGhC,WAAW;QAC3B,IAAI,CAACiC,SAAS,GAAGjC,WAAW;QAC5B,IAAI,CAACkC,UAAU,GAAGlC,WAAW;QAC7B,IAAI,CAACmC,YAAY,GAAGnC,WAAW;QAC/B,IAAI,CAACoC,aAAa,GAAGpC,WAAW;QAChC,IAAI,CAACqC,SAAS,GAAGrC,WAAW;QAC5B,IAAI,CAACsC,QAAQ,GAAGtC,WAAW;QAC3B,IAAI,CAACuC,mBAAmB,GAAGvC,WAAW;IAC1C;IAEA8B,UAAU;QACN,MAAM,EAAEU,IAAG,EAAEC,OAAM,EAAE,GAAG,IAAI,CAACC,GAAG;QAEhC,MAAMC,OAAO,IAAIC,IAAIJ;QACrB,MAAMK,QAAQF,KAAKG,QAAQ;QAC3B,MAAMC,UAAU,CAAC,OAAO,EAAEN,OAAO,CAAC,EAAEI,MAAM,EAAE,EAAE,IAAI,CAAC7C,MAAM,CAAC,CAAC,CAAC;QAC5D,MAAMM,QAAQ,IAAIE,MAAMuC;QACxBzC,MAAMN,MAAM,GAAG,IAAI,CAACA,MAAM;QAC1BM,MAAMmC,MAAM,GAAGA;QACfnC,MAAMkC,GAAG,GAAGK;QAEZ,OAAOvC;IACX;IAzFA0C,YAAYvD,OAAO,EAAEC,QAAQ,CAAE;QAC3B,IAAI,CAACgD,GAAG,GAAGjD;QACX,IAAI,CAACS,GAAG,GAAGR;QACX,IAAI,CAACqB,OAAO,GAAG,IAAI,CAACH,MAAM,GAAG,CAAC;QAE9B,IAAI,CAACQ,oBAAoB;QACzB,IAAI,CAACN,WAAW;IACpB;AAmFJ;MAEA,WAAevB"}