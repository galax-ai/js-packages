{"version":3,"sources":["../src/modifier.js"],"sourcesContent":["import { InvalidArgument, ValidationError } from '@galaxar/types';\nimport { eachAsync_ } from '@galaxar/utils';\n\nfunction getHandler(modifier, handlers) {\n    let handlerType = null;\n    let handlerKey = modifier.substring(1);\n    let isValidator = false;\n    let isActivator = false;\n\n    if (modifier.startsWith('~')) {\n        handlerType = handlers.validator;\n        isValidator = true;\n    } else if (modifier.startsWith('|')) {\n        handlerType = handlers.processor;\n    } else if (modifier.startsWith('=')) {\n        handlerType = handlers.activator;\n        isActivator = true;\n    } else {\n        throw new InvalidArgument(`Unknown modifier: ${modifier}`);\n    }\n\n    const hanlder = handlerType[handlerKey];\n\n    if (!hanlder) {\n        throw new InvalidArgument(`Handler not found for modifier: ${modifier}`);\n    }\n\n    if (isValidator) {\n        return validatorWrapper(hanlder);\n    }\n\n    if (isActivator) {\n        return activatorWrapper(hanlder);\n    }\n\n    return processorWrapper(hanlder);\n}\n\nfunction validatorWrapper(validator) {\n    return (value, options, meta, context) => {\n        if (value == null) return value;\n\n        const [validated, reason] = validator(value, options, meta, context);\n\n        if (!validated) {\n            throw new ValidationError(reason, { value, options });\n        }\n\n        return value;\n    };\n}\n\nfunction processorWrapper(processor) {\n    return (value, options, meta, context) => {\n        if (value == null) return value;\n        return processor(value, options, meta, context);\n    };\n}\n\nfunction activatorWrapper(activator) {\n    return (value, options, meta, context) => {\n        if (value == null) {\n            return activator(options, meta, context);\n        }\n\n        return value;\n    };\n}\n\nfunction createModifier(modifierItem, handlers) {\n    let modifier;\n    let options;\n    const type = typeof modifierItem;\n\n    if (type === 'string') {\n        modifier = modifierItem;\n    } else if (Array.isArray(modifierItem)) {\n        [modifier, options] = modifierItem;\n    } else if (type === 'object') {\n        modifier = modifierItem.name;\n        options = modifierItem.options;\n    }\n\n    if (!modifier) {\n        throw new InvalidArgument(`Invalid modifier syntax: ${JSON.stringify(modifierItem)}`);\n    }\n\n    return [getHandler(modifier, handlers), options];\n}\n\nconst applyModifiers = (value, meta, context) =>\n    meta.mod.reduce((_value, modifier) => {\n        const [handler, options] = createModifier(modifier, context.system.handlers);\n        return handler(_value, options, meta, context);\n    }, value);\n\nconst applyModifiers_ = async (value, meta, context) => {\n    await eachAsync_(meta.mod, async (modifier) => {\n        const [handler, options] = createModifier(modifier, context.system.handlers);\n        value = await handler(value, options, meta, context);\n    });\n\n    return value;\n};\n\nexport const postProcess_ = async (value, meta, opts) => {\n    if (meta.mod) {\n        value = await applyModifiers_(value, meta, opts);\n    }\n\n    return value;\n};\n\nexport const postProcess = (value, meta, opts) => {\n    if (meta.mod) {\n        value = applyModifiers(value, meta, opts);\n    }\n\n    return value;\n};\n"],"names":["postProcess_","postProcess","getHandler","modifier","handlers","handlerType","handlerKey","substring","isValidator","isActivator","startsWith","validator","processor","activator","InvalidArgument","hanlder","validatorWrapper","activatorWrapper","processorWrapper","value","options","meta","context","validated","reason","ValidationError","createModifier","modifierItem","type","Array","isArray","name","JSON","stringify","applyModifiers","mod","reduce","_value","handler","system","applyModifiers_","eachAsync_","opts"],"mappings":"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"}