{"version":3,"sources":["../../../src/builtins/app-module/index.js"],"sourcesContent":["const path = require(\"path\");\nconst { fs } = require('@genx/sys');\nconst localConfig = require(\"./config\");\nconst { steps, packageConfig } = require(\"../..\");\nconst getTemplatePath = require(\"../../utils/getTemplatePath\");\n\nasync function updateServerConfig_(app, options) {\n    const serverConfigFileName = 'conf/server.default.json';\n    const serverConfigFile = path.join(options.workingPath, serverConfigFileName);\n    const serverConfig = await fs.readJson(serverConfigFile);\n    const route = `/${options.appDir}`;\n\n    if (serverConfig.appRouting) {\n        if (route in serverConfig.appRouting) {\n            if (serverConfig.appRouting[route].name === options.appDir) {\n                app.log('info', 'Skipped updating the server default config. The app module has already been added into the \"appRouting\" section.');\n                return;\n            }\n\n            throw new Error(`Route \"${route}\" already exists.`);\n        }\n    } else {\n        serverConfig.appRouting = {};\n    }    \n\n    serverConfig.appRouting[route] = {\n        name: options.appDir,\n        options: {}\n    };\n\n    await fs.writeJson(serverConfigFile, serverConfig, { spaces: 4 });\n    app.log('info', `Updated \"appRouting\" in server default config: ${serverConfigFileName}`);\n}\n\nmodule.exports = async (app, options) => {\n    options = {\n        ...localConfig,\n        ...options,\n    };    \n\n    await steps.requireFilesExist_(app, options.workingPath, [\n        'package.json',\n        'conf/server.default.json'\n    ]);\n\n    const rootTemplatePath = getTemplatePath(options.appMode, 'root');\n    await steps.copyFilesFromTemplate_(app, rootTemplatePath, options.workingPath, options, true /**skip overriding */);\n\n    const targetPath = path.join(options.workingPath, 'app_modules', options.appDir);\n    fs.ensureDirSync(targetPath);\n\n    const templatePath = getTemplatePath(options.appMode, 'module');\n    await steps.copyFilesFromTemplate_(app, templatePath, targetPath, options);\n\n    await updateServerConfig_(app, options);   \n    \n    await steps.updatePackageJson_(app, targetPath, (config) => packageConfig.addPackages(config, options));    \n\n    await steps.npmInstall_(app, options.workingPath, options);\n};\n"],"names":["path","require","fs","localConfig","steps","packageConfig","getTemplatePath","updateServerConfig_","app","options","serverConfigFileName","serverConfigFile","join","workingPath","serverConfig","readJson","route","appDir","appRouting","name","log","Error","writeJson","spaces","module","exports","requireFilesExist_","rootTemplatePath","appMode","copyFilesFromTemplate_","targetPath","ensureDirSync","templatePath","updatePackageJson_","config","addPackages","npmInstall_"],"mappings":";AAAA,MAAMA,OAAOC,QAAQ;AACrB,MAAM,EAAEC,GAAE,EAAE,GAAGD,QAAQ;AACvB,MAAME,cAAcF,QAAQ;AAC5B,MAAM,EAAEG,MAAK,EAAEC,cAAa,EAAE,GAAGJ,QAAQ;AACzC,MAAMK,kBAAkBL,QAAQ;AAEhC,eAAeM,oBAAoBC,GAAG,EAAEC,OAAO,EAAE;IAC7C,MAAMC,uBAAuB;IAC7B,MAAMC,mBAAmBX,KAAKY,IAAI,CAACH,QAAQI,WAAW,EAAEH;IACxD,MAAMI,eAAe,MAAMZ,GAAGa,QAAQ,CAACJ;IACvC,MAAMK,QAAQ,CAAC,CAAC,EAAEP,QAAQQ,MAAM,CAAC,CAAC;IAElC,IAAIH,aAAaI,UAAU,EAAE;QACzB,IAAIF,SAASF,aAAaI,UAAU,EAAE;YAClC,IAAIJ,aAAaI,UAAU,CAACF,MAAM,CAACG,IAAI,KAAKV,QAAQQ,MAAM,EAAE;gBACxDT,IAAIY,GAAG,CAAC,QAAQ;gBAChB;YACJ,CAAC;YAED,MAAM,IAAIC,MAAM,CAAC,OAAO,EAAEL,MAAM,iBAAiB,CAAC,EAAE;QACxD,CAAC;IACL,OAAO;QACHF,aAAaI,UAAU,GAAG,CAAC;IAC/B,CAAC;IAEDJ,aAAaI,UAAU,CAACF,MAAM,GAAG;QAC7BG,MAAMV,QAAQQ,MAAM;QACpBR,SAAS,CAAC;IACd;IAEA,MAAMP,GAAGoB,SAAS,CAACX,kBAAkBG,cAAc;QAAES,QAAQ;IAAE;IAC/Df,IAAIY,GAAG,CAAC,QAAQ,CAAC,+CAA+C,EAAEV,qBAAqB,CAAC;AAC5F;AAEAc,OAAOC,OAAO,GAAG,OAAOjB,KAAKC,UAAY;IACrCA,UAAU;QACN,GAAGN,WAAW;QACd,GAAGM,OAAO;IACd;IAEA,MAAML,MAAMsB,kBAAkB,CAAClB,KAAKC,QAAQI,WAAW,EAAE;QACrD;QACA;KACH;IAED,MAAMc,mBAAmBrB,gBAAgBG,QAAQmB,OAAO,EAAE;IAC1D,MAAMxB,MAAMyB,sBAAsB,CAACrB,KAAKmB,kBAAkBlB,QAAQI,WAAW,EAAEJ,SAAS,IAAI;IAE5F,MAAMqB,aAAa9B,KAAKY,IAAI,CAACH,QAAQI,WAAW,EAAE,eAAeJ,QAAQQ,MAAM;IAC/Ef,GAAG6B,aAAa,CAACD;IAEjB,MAAME,eAAe1B,gBAAgBG,QAAQmB,OAAO,EAAE;IACtD,MAAMxB,MAAMyB,sBAAsB,CAACrB,KAAKwB,cAAcF,YAAYrB;IAElE,MAAMF,oBAAoBC,KAAKC;IAE/B,MAAML,MAAM6B,kBAAkB,CAACzB,KAAKsB,YAAY,CAACI,SAAW7B,cAAc8B,WAAW,CAACD,QAAQzB;IAE9F,MAAML,MAAMgC,WAAW,CAAC5B,KAAKC,QAAQI,WAAW,EAAEJ;AACtD"}