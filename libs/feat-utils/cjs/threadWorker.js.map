{"version":3,"sources":["../lib/threadWorker.js"],"sourcesContent":["import { parentPort } from 'node:worker_threads';\nimport { Feature } from '@galaxar/app';\n\n/**\n * Hasher, get the hash of a buffer/string/stream/file.\n * @module Feature_Hasher\n */\n\nexport default {\n    /**\n     * This feature is loaded at service stage\n     * @member {string}\n     */\n    stage: Feature.SERVICE,\n\n    /**\n     * Load the feature\n     * @param {App} app - The app module object\n     * @param {object} [options] - Options for the feature\n     * @returns {Promise.<void>}\n     */\n    load_: async function (app, options, name) {\n        const { logMessage, logLevel } = app.featureConfig(\n            options,\n            {\n                schema: {\n                    logMessage: { type: 'boolean', default: false },\n                    logLevel: { type: 'text', enum: ['info', 'verbose'], default: 'info' },\n                },\n            },\n            name\n        );\n\n        const perfCounter = {\n            numTasks: 0,\n            numTasksCompleted: 0,\n            numTasksFailed: 0,         \n            totalTaskTime: 0,\n            averageTaskTime: 0,   \n            maxTaskTime: 0,\n        };\n\n        const service = {\n            get perfCounter() {\n                return perfCounter;\n            },\n            start(handlers) {\n                if (parentPort) {\n                    parentPort.on('close', async () => {\n                        app.log('info', 'Thread worker closed by main thread.');\n                        await app.stop_();\n                    });\n                    parentPort.on('message', async (message) => {\n                        perfCounter.numTasks++;\n                        const startTime = Date.now();\n\n                        try {\n                            if (logMessage) {\n                                app.log(logLevel, 'Received message from main thread.', message);\n                            }\n\n                            const { id, task, payload } = message;\n                            const handler = handlers[task];\n\n                            if (handler == null) {\n                                throw new Error(`Unknown task \"${task}\".`);\n                            }\n\n                            const result = await handler(payload);\n                            const { value, transferList } = result || {};\n                            parentPort.postMessage({ id, value }, transferList);\n                            perfCounter.numTasksCompleted++;\n\n                            const endTime = Date.now();\n                            const taskTime = endTime - startTime;\n                            perfCounter.totalTaskTime += taskTime;\n                            perfCounter.averageTaskTime = perfCounter.totalTaskTime / perfCounter.numTasksCompleted;\n                            perfCounter.maxTaskTime = Math.max(perfCounter.maxTaskTime, taskTime);\n                        } catch (error) {\n                            perfCounter.numTasksFailed++;\n                            app.logError(error);\n\n                            const newError = { message: error.message, stack: error.stack };\n\n                            for (const [key, value] of Object.entries(error)) {\n                                if (typeof value !== 'object') {\n                                    newError[key] = value;\n                                }\n                            }\n\n                            parentPort.postMessage({ id: message.id, error: newError });\n                        }\n                    });\n                } else {\n                    throw new Error('This feature can only be used in a worker thread.');\n                }\n            },\n        };\n\n        app.registerService(name, service);\n    },\n};\n"],"names":["stage","Feature","SERVICE","load_","app","options","name","logMessage","logLevel","featureConfig","schema","type","default","enum","perfCounter","numTasks","numTasksCompleted","numTasksFailed","totalTaskTime","averageTaskTime","maxTaskTime","service","start","handlers","parentPort","on","log","stop_","message","startTime","Date","now","id","task","payload","handler","Error","result","value","transferList","postMessage","endTime","taskTime","Math","max","error","logError","newError","stack","key","Object","entries","registerService"],"mappings":";;;;+BAGA;;;CAGC,GAED;;;eAAA;;;oCAR2B;qBACH;MAOxB,WAAe;IACX;;;KAGC,GACDA,OAAOC,YAAO,CAACC,OAAO;IAEtB;;;;;KAKC,GACDC,OAAO,eAAgBC,GAAG,EAAEC,OAAO,EAAEC,IAAI,EAAE;QACvC,MAAM,EAAEC,WAAU,EAAEC,SAAQ,EAAE,GAAGJ,IAAIK,aAAa,CAC9CJ,SACA;YACIK,QAAQ;gBACJH,YAAY;oBAAEI,MAAM;oBAAWC,SAAS,KAAK;gBAAC;gBAC9CJ,UAAU;oBAAEG,MAAM;oBAAQE,MAAM;wBAAC;wBAAQ;qBAAU;oBAAED,SAAS;gBAAO;YACzE;QACJ,GACAN;QAGJ,MAAMQ,cAAc;YAChBC,UAAU;YACVC,mBAAmB;YACnBC,gBAAgB;YAChBC,eAAe;YACfC,iBAAiB;YACjBC,aAAa;QACjB;QAEA,MAAMC,UAAU;YACZ,IAAIP,eAAc;gBACd,OAAOA;YACX;YACAQ,OAAMC,QAAQ,EAAE;gBACZ,IAAIC,8BAAU,EAAE;oBACZA,8BAAU,CAACC,EAAE,CAAC,SAAS,UAAY;wBAC/BrB,IAAIsB,GAAG,CAAC,QAAQ;wBAChB,MAAMtB,IAAIuB,KAAK;oBACnB;oBACAH,8BAAU,CAACC,EAAE,CAAC,WAAW,OAAOG,UAAY;wBACxCd,YAAYC,QAAQ;wBACpB,MAAMc,YAAYC,KAAKC,GAAG;wBAE1B,IAAI;4BACA,IAAIxB,YAAY;gCACZH,IAAIsB,GAAG,CAAClB,UAAU,sCAAsCoB;4BAC5D,CAAC;4BAED,MAAM,EAAEI,GAAE,EAAEC,KAAI,EAAEC,QAAO,EAAE,GAAGN;4BAC9B,MAAMO,UAAUZ,QAAQ,CAACU,KAAK;4BAE9B,IAAIE,WAAW,IAAI,EAAE;gCACjB,MAAM,IAAIC,MAAM,CAAC,cAAc,EAAEH,KAAK,EAAE,CAAC,EAAE;4BAC/C,CAAC;4BAED,MAAMI,SAAS,MAAMF,QAAQD;4BAC7B,MAAM,EAAEI,MAAK,EAAEC,aAAY,EAAE,GAAGF,UAAU,CAAC;4BAC3Cb,8BAAU,CAACgB,WAAW,CAAC;gCAAER;gCAAIM;4BAAM,GAAGC;4BACtCzB,YAAYE,iBAAiB;4BAE7B,MAAMyB,UAAUX,KAAKC,GAAG;4BACxB,MAAMW,WAAWD,UAAUZ;4BAC3Bf,YAAYI,aAAa,IAAIwB;4BAC7B5B,YAAYK,eAAe,GAAGL,YAAYI,aAAa,GAAGJ,YAAYE,iBAAiB;4BACvFF,YAAYM,WAAW,GAAGuB,KAAKC,GAAG,CAAC9B,YAAYM,WAAW,EAAEsB;wBAChE,EAAE,OAAOG,OAAO;4BACZ/B,YAAYG,cAAc;4BAC1Bb,IAAI0C,QAAQ,CAACD;4BAEb,MAAME,WAAW;gCAAEnB,SAASiB,MAAMjB,OAAO;gCAAEoB,OAAOH,MAAMG,KAAK;4BAAC;4BAE9D,KAAK,MAAM,CAACC,KAAKX,MAAM,IAAIY,OAAOC,OAAO,CAACN,OAAQ;gCAC9C,IAAI,OAAOP,UAAU,UAAU;oCAC3BS,QAAQ,CAACE,IAAI,GAAGX;gCACpB,CAAC;4BACL;4BAEAd,8BAAU,CAACgB,WAAW,CAAC;gCAAER,IAAIJ,QAAQI,EAAE;gCAAEa,OAAOE;4BAAS;wBAC7D;oBACJ;gBACJ,OAAO;oBACH,MAAM,IAAIX,MAAM,qDAAqD;gBACzE,CAAC;YACL;QACJ;QAEAhC,IAAIgD,eAAe,CAAC9C,MAAMe;IAC9B;AACJ"}