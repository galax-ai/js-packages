{"version":3,"sources":["../lib/webSocketClient.js"],"sourcesContent":["import { Feature } from '@galaxar/app';\n\nexport default {\n    stage: Feature.SERVICE,\n\n    groupable: true,\n\n    load_: async function (app, options, name) {\n        const {\n            endpoint,\n            autoReconnect,\n            reconnectInterval = 5000,\n            wsOptions,\n        } = app.featureConfig(\n            options,\n            {\n                schema: {\n                    endpoint: { type: 'text' },\n                    autoReconnect: { type: 'boolean', default: true },\n                    reconnectInterval: { type: 'integer', default: 5000 },\n                    wsOptions: { type: 'object', optional: true },\n                },\n            },\n            name\n        );\n\n        const WebSocket = app.tryRequire('ws');\n\n        let ws;\n        let wsConnected = false;\n        let shouldReconnect = autoReconnect;\n        const queue = [];\n\n        const wsClient = {\n            get isConnected() {\n                return wsConnected;\n            },\n\n            onMessage: null,\n            onReconnect: null,\n            onClose: null,\n            onError: null,\n\n            async connect_(reconnect = false) {\n                if (wsConnected) {\n                    return wsClient;\n                }\n\n                return new Promise((resolve, reject) => {\n                    ws = new WebSocket(endpoint, wsOptions);\n\n                    ws.on('open', () => {\n                        wsConnected = true;\n\n                        queue.forEach(({ data, resolve, reject }) => {\n                            ws.send(data, (error) => {\n                                if (error) {\n                                    reject(error);\n                                } else {\n                                    resolve();\n                                }\n                            });\n                        });\n\n                        queue.length = 0;\n\n                        app.log('info', `Successfully connected to web socket \"${endpoint}\".`);\n\n                        resolve(wsClient);\n\n                        if (reconnect) {\n                            wsClient.onReconnect?.();\n                        }\n                    });\n\n                    ws.on('message', (data) => {\n                        wsClient.onMessage?.(data);\n                    });\n\n                    ws.on('close', (code, reason) => {\n                        wsConnected = false;\n\n                        app.log('info', `Disconnected from web socket \"${endpoint}\".`);\n\n                        wsClient.onClose?.(code, reason);\n                        ws = null;\n\n                        if (shouldReconnect) {\n                            setTimeout(\n                                () => wsClient.connect_(true).catch(app.logError),\n                                reconnectInterval\n                            );\n                        }\n                    });\n\n                    ws.on('error', (error) => {\n                        if (!wsConnected) {\n                            reject(error);\n                        } else {\n                            app.logError(error);\n                        }\n                    });\n\n                    ws.on('unexpected-response', () => {\n                        app.log('warn', `Unexpected response from web socket \"${endpoint}\".`);\n                    });\n                });\n            },\n\n            async send_(data) {\n                return new Promise((resolve, reject) => {\n                    if (!wsConnected) {\n                        queue.push({ data, resolve, reject });\n                    } else {\n                        ws.send(data, (error) => {\n                            if (error) {\n                                reject(error);\n                            } else {\n                                resolve();\n                            }\n                        });\n                    }\n                });\n            },\n\n            close() {\n                shouldReconnect = false;\n                ws?.close();\n                ws = null;\n\n                queue.forEach((item) => {\n                    item.reject(new Error('WebSocket closed.'));\n                });\n                queue.length = 0;\n            },\n        };\n\n        app.on('ready', () => {\n            wsClient.connect_().catch(app.logError);\n        });\n\n        app.on('stopping', () => {\n            wsClient.close();\n        });\n\n        app.registerService(name, wsClient);\n    },\n};\n"],"names":["stage","Feature","SERVICE","groupable","load_","app","options","name","endpoint","autoReconnect","reconnectInterval","wsOptions","featureConfig","schema","type","default","optional","WebSocket","tryRequire","ws","wsConnected","shouldReconnect","queue","wsClient","isConnected","onMessage","onReconnect","onClose","onError","connect_","reconnect","Promise","resolve","reject","on","forEach","data","send","error","length","log","code","reason","setTimeout","catch","logError","send_","push","close","item","Error","registerService"],"mappings":"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"}