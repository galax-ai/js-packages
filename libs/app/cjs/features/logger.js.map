{"version":3,"sources":["../../lib/features/logger.js"],"sourcesContent":["/**\n * Enable multi-categories logging by pino logger\n * @module Feature_Logger\n */\n\nimport Feature from '../Feature';\nimport { _ } from '@galaxar/utils';\n\n/*\n logger: {\n     transport: {\n        target: '/absolute/path/to/my-transport.mjs'\n     }\n }\n\n logger: {\n    transport: {\n    targets: [\n      { target: '/absolute/path/to/my-transport.mjs', level: 'error' },\n      { target: 'some-file-transport', options: { destination: '/dev/null' }\n    ]\n }    \n*/\nexport default {\n    /**\n     * This feature is loaded at service stage\n     * @member {string}\n     */\n    stage: Feature.SERVICE,\n\n    groupable: true,\n\n    /**\n     * Load the feature\n     * @param {App} app - The cli app module object\n     * @param {object} categories - Configuration for multi-categories\n     * @returns {Promise.<*>}\n     * @example\n     *\n     *  let logger = app.getService('logger');\n     *  logger.log('error', 'error');\n     *\n     *  // with serviceGroup\n     *  let logger1 = app.getService('logger-category1');\n     */\n    load_: function (app, config, name) {\n        const pino = app.tryRequire('pino');\n\n        config = app.featureConfig(\n            config,\n            {\n                schema: {\n                    transport: { type: 'object', optional: true },\n                },\n            },\n            name\n        );\n\n        const options = {\n            nestedKey: 'payload',\n            transport: {\n                target: 'pino-pretty',\n                options: {\n                    colorize: true,\n                },\n            },\n            ...config,\n        };\n\n        const names = name.split('-', 2);\n        let isAppLogger = true;\n\n        if (names.length > 1) {\n            options.name = names[1];\n            isAppLogger = false;\n        }\n\n        const logger = pino({\n            level: app.options.logLevel === 'verbose' ? 'debug' : app.options.logLevel,\n            ...options,\n        });\n\n        if (isAppLogger) {\n            logger.verbose = logger.debug.bind(logger);\n\n            if (app._logCache.length > 0) {\n                app._logCache.forEach(([level, message, obj]) => logger[level](obj, message));\n            }\n\n            app.logger = logger;\n            app.log = (level, message, info) => {\n                logger[level](info, message);\n                return this;\n            };\n        }\n\n        app.registerService(name, logger);\n    },\n};\n"],"names":["stage","Feature","SERVICE","groupable","load_","app","config","name","pino","tryRequire","featureConfig","schema","transport","type","optional","options","nestedKey","target","colorize","names","split","isAppLogger","length","logger","level","logLevel","verbose","debug","bind","_logCache","forEach","message","obj","log","info","registerService"],"mappings":"AAAA;;;CAGC;;;;+BAKD;;;;;;;;;;;;;;AAcA,GACA;;;eAAA;;;gEAlBoB;uBACF;;;;;;MAiBlB,WAAe;IACX;;;KAGC,GACDA,OAAOC,gBAAO,CAACC,OAAO;IAEtBC,WAAW,IAAI;IAEf;;;;;;;;;;;;KAYC,GACDC,OAAO,SAAUC,GAAG,EAAEC,MAAM,EAAEC,IAAI,EAAE;QAChC,MAAMC,OAAOH,IAAII,UAAU,CAAC;QAE5BH,SAASD,IAAIK,aAAa,CACtBJ,QACA;YACIK,QAAQ;gBACJC,WAAW;oBAAEC,MAAM;oBAAUC,UAAU,IAAI;gBAAC;YAChD;QACJ,GACAP;QAGJ,MAAMQ,UAAU;YACZC,WAAW;YACXJ,WAAW;gBACPK,QAAQ;gBACRF,SAAS;oBACLG,UAAU,IAAI;gBAClB;YACJ;YACA,GAAGZ,MAAM;QACb;QAEA,MAAMa,QAAQZ,KAAKa,KAAK,CAAC,KAAK;QAC9B,IAAIC,cAAc,IAAI;QAEtB,IAAIF,MAAMG,MAAM,GAAG,GAAG;YAClBP,QAAQR,IAAI,GAAGY,KAAK,CAAC,EAAE;YACvBE,cAAc,KAAK;QACvB,CAAC;QAED,MAAME,SAASf,KAAK;YAChBgB,OAAOnB,IAAIU,OAAO,CAACU,QAAQ,KAAK,YAAY,UAAUpB,IAAIU,OAAO,CAACU,QAAQ;YAC1E,GAAGV,OAAO;QACd;QAEA,IAAIM,aAAa;YACbE,OAAOG,OAAO,GAAGH,OAAOI,KAAK,CAACC,IAAI,CAACL;YAEnC,IAAIlB,IAAIwB,SAAS,CAACP,MAAM,GAAG,GAAG;gBAC1BjB,IAAIwB,SAAS,CAACC,OAAO,CAAC,CAAC,CAACN,OAAOO,SAASC,IAAI,GAAKT,MAAM,CAACC,MAAM,CAACQ,KAAKD;YACxE,CAAC;YAED1B,IAAIkB,MAAM,GAAGA;YACblB,IAAI4B,GAAG,GAAG,CAACT,OAAOO,SAASG,OAAS;gBAChCX,MAAM,CAACC,MAAM,CAACU,MAAMH;gBACpB,OAAO,IAAI;YACf;QACJ,CAAC;QAED1B,IAAI8B,eAAe,CAAC5B,MAAMgB;IAC9B;AACJ"}