{"version":3,"sources":["../../lib/helpers/HttpClient.js"],"sourcesContent":["import { _, url as urlUtil } from '@galaxar/utils';\n\n/**\n * Enable a http client as service\n * @module Feature_HttpClient\n */\n\nconst DefaultMethods = {\n    get: 'get',\n    post: 'post',\n    put: 'put',\n    del: 'del',\n    delete: 'del',\n    upload: 'post',\n    download: 'get',\n};\n\nfunction resToPath(parts) {\n    return parts ? (Array.isArray(parts) ? parts.map((res) => encodeURIComponent(res)).join('/') : parts) : '';\n}\n\n/**\n * HTTP client.\n * @class\n */\nclass HttpClient {\n    /**\n     *\n     * @param {*} endpoint\n     */\n    constructor(adapter, endpointOrOptions) {\n        this.adapter = adapter;\n        this.options = typeof endpointOrOptions === 'string' ? { endpoint: endpointOrOptions } : endpointOrOptions;\n    }\n\n    /**\n     *\n     * @param {string} method\n     * @param {string} path\n     * @param {object} query\n     * @param {object} body\n     * @param {object} options - Request options\n     * @property {string} [options.httpMethod] - Specified the http method to override the method argument\n     * @property {string} [options.endpoint] - Specified the base endpoint for this request only\n     * @property {function} [options.onSend] - Specified the onSend hook for this request only\n     * @property {integer} [options.timeout] - Specified the timeout setting for this request only\n     * @property {object} [options.headers] - Specified the headers for this request only\n     * @property {boolean} [options.withCredentials] - Specified the withCredentials header for CORS\n     * @property {object} [options.formData] - Specified the form fields\n     * @property {object} [options.fileField='file'] - Specified the file field name\n     * @property {object} [options.fileName] - Specified the file name to override the file to upload\n     * @property {function} [options.onProgress] - Specified the on progress callback\n     * @returns {*}\n     */\n    async do(method, path, query, body, options) {\n        method = method.toLowerCase();\n        const _options = { ...this.options, ...options };\n\n        let httpMethod = _options.httpMethod ?? DefaultMethods[method];\n        if (!httpMethod) {\n            throw new Error('Invalid method: ' + method);\n        }\n\n        let url = path.startsWith('http:') || path.startsWith('https:') ? path : urlUtil.join(_options.endpoint, path);\n\n        let req = this.adapter.createRequest(this, httpMethod, url);\n\n        if (this.onSending) {\n            this.onSending(req);\n        }\n\n        if (_options.onSending) {\n            _options.onSending(req);\n        }\n\n        if (_options.timeout) {\n            req.timeout(_options.timeout);\n        }\n\n        if (_options.headers) {\n            _.each(_options.headers, (v, k) => {\n                req.set(k, v);\n            });\n        }\n\n        if (_options.withCredentials) {\n            req.withCredentials();\n        }\n\n        if (query) {\n            req.query(query);\n        }\n\n        if (method === 'download') {\n            if (httpMethod !== 'get') {\n                req.send(body);\n            }\n        } else if (method === 'upload') {\n            if (_options.formData) {\n                _.each(_options.formData, (v, k) => {\n                    req.field(k, v);\n                });\n            }\n            req.attach(_options.fileField ?? 'file', body, _options.fileName);\n        } else if (httpMethod !== 'get') {\n            req.send(body ?? _options.body);\n        }\n\n        if (_options.onProgress) {\n            req.on('progress', _options.onProgress);\n        }\n\n        try {\n            const res = await req;\n            const result = res.type.startsWith('text/') ? res.text : res.body;\n\n            if (this.onResponse) {\n                this.onResponse(result, req, res);\n            }\n\n            if (_options.onResponse) {\n                _options.onResponse(result, req, res);\n            }\n\n            return result;\n        } catch (error) {\n            const _onError = _options.onError ?? this.onError;\n\n            if (error.response && error.response.error) {\n                const _responseError = error.response.error;\n\n                if (error.response.type === 'application/json') {\n                    _responseError.body = JSON.parse(error.response.text);\n                }\n\n                if (_onError != null) {\n                    return _onError(_responseError, error);\n                }\n\n                throw _responseError;\n            }\n\n            if (_onError != null) {\n                return _onError(error);\n            }\n\n            throw error;\n        }\n    }\n\n    async get(resource, query, options) {\n        return this.do('get', resToPath(resource), query, null, options);\n    }\n\n    async post(resource, data, query, options) {\n        return this.do('post', resToPath(resource), query, data, options);\n    }\n\n    async put(resource, data, query, options) {\n        return this.do('put', resToPath(resource), query, data, options);\n    }\n\n    async del(resource, query, options) {\n        return this.do('del', resToPath(resource), query, null, options);\n    }\n\n    async delete(...args) {\n        return this.del(...args);\n    }\n\n    async upload(resource, file, query, options) {\n        return this.do('upload', resToPath(resource), query, file, options);\n    }\n\n    async download(resource, query, options) {\n        return this.do('download', resToPath(resource), query, null, options);\n    }\n}\n\nexport default HttpClient;\n"],"names":["DefaultMethods","get","post","put","del","delete","upload","download","resToPath","parts","Array","isArray","map","res","encodeURIComponent","join","HttpClient","do","method","path","query","body","options","toLowerCase","_options","httpMethod","Error","url","startsWith","urlUtil","endpoint","req","adapter","createRequest","onSending","timeout","headers","_","each","v","k","set","withCredentials","send","formData","field","attach","fileField","fileName","onProgress","on","result","type","text","onResponse","error","_onError","onError","response","_responseError","JSON","parse","resource","data","args","file","constructor","endpointOrOptions"],"mappings":"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"}