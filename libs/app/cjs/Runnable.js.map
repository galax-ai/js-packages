{"version":3,"sources":["../lib/Runnable.js"],"sourcesContent":["import { _, sleep_, batchAsync_ } from '@galaxar/utils';\nimport { InvalidConfiguration } from '@galaxar/types';\nimport { defaultAppOpts } from './defaultOpts';\n\n/**\n * Runnable app mixin.\n * @param {object} T - Base class.\n * @returns {Runnable} A runable app class.\n * @constructs Runnable(T)\n */\nconst Runnable = (T) =>\n    class extends T {\n        _getOnUncaughtException = (exitOnError) => (err) => {\n            if (exitOnError) {\n                //wait 1 second for flushing the last log\n                this.log('error', err);\n            } else {\n                this.logError(err);\n            }\n        };\n\n        _onWarning = (warning) => {\n            this.log('warn', warning.message);\n        };\n\n        _onExit = (code) => {\n            if (this.started) {\n                this.stop_().catch(this.logError);\n            }\n        };\n\n        /**\n         * @param {string} name - The name of the application.\n         * @param {object} [options] - Application options\n         * @property {string} [options.logLevel='info'] - Logging level\n         * @property {object} [options.ignoreUncaught=false] - Whether to skip the handling of uncaught exception\n         * @property {object} [options.exitOnUncaught=true] - Whether to exit process on uncaught exception thrown\n         * @constructs Runnable\n         */\n        constructor(name, options) {\n            super(name, {\n                ...defaultAppOpts,\n                ...options,\n            });\n\n            this.runnable = true;\n\n            this.libModulesPath = this.toAbsolutePath(this.options.libModulesPath);\n        }\n\n        /**\n         * Start the app\n         * @returns {Promise}\n         * @memberof Runnable\n         */\n        async start_() {\n            if (this.started) {\n                throw new Error('App already started.');\n            }\n\n            this._initialize();\n\n            process.on('exit', this._onExit);\n\n            try {\n                await super.start_();\n            } catch (error) {\n                if (error.code === 'E_INVALID_CONF') {\n                    throw new Error(`Invalid configuration. Reason: ${error.message} Info: ${JSON.stringify(error.info)}`);\n                }\n\n                throw error;\n            }           \n\n            if (this.options.logLevel === 'verbose' || this.options.logLevel === 'debug') {\n                const childModules = {};\n                this.visitChildModules((childModule, name) => {\n                    childModules[name] = {\n                        features: Object.keys(childModule.features),\n                        services: Object.keys(childModule.services),\n                    };\n                });\n\n                this.log('verbose', 'Enabled features & services:', {\n                    features: Object.keys(this.features),\n                    services: Object.keys(this.services),\n                    modules: childModules,\n                });\n            }\n\n            return this;\n        }\n\n        /**\n         * Stop the app\n         * @returns {Promise}\n         * @memberof Runnable\n         */\n        async stop_() {\n            let stopByThis = false;\n\n            if (this.started) {\n                stopByThis = true;\n\n                if (this.libModules) {\n                    await batchAsync_(this.libModules, (lib) => lib.stop_());\n                    delete this.libModules;\n                }\n            }\n\n            process.removeListener('exit', this._onExit);\n\n            await super.stop_();\n\n            await sleep_(0);\n\n            if (stopByThis) {\n                this._uninitialize();\n            }\n        }\n\n        visitChildModules(vistor) {\n            if (this.libModules) {\n                _.each(this.libModules, vistor);\n            }\n        }\n\n        /**\n         * Get the lib module\n         * @param {string} libName\n         * @memberof Runnable\n         */\n        getLib(libName) {\n            if (!this.libModules) {\n                throw new Error('\"libModules\" feature is required to access lib among modules.');\n            }\n\n            let libModule = this.libModules[libName];\n\n            if (!libModule) {\n                throw new Error(`Lib module [${libName}] not found.`);\n            }\n\n            return libModule;\n        }\n\n        /**\n         * Require a module from the source path of a library module\n         * @param {*} relativePath\n         * @memberof Runnable\n         */\n        requireFromLib(libName, relativePath) {\n            let libModule = this.getLib(libName);\n            return libModule.require(relativePath);\n        }\n\n        /**\n         * Register a loaded lib module\n         * @param {LibModule} lib\n         * @memberof Runnable\n         */\n        registerLib(lib) {\n            if (!this.libModules) {\n                this.libModules = {};\n            }\n\n            if (lib.name in this.libModules) {\n                throw new InvalidConfiguration(`Lib module [${lib.name}] already exists.`, this, {\n                    name: lib.name,\n                });\n            }\n\n            this.libModules[lib.name] = lib;\n        }\n\n        /**\n         * Get a registered service\n         * @param {string} name\n         *\n         * @example\n         *  // Get service from a lib module\n         *  const service = app.getService('<lib name>/<service name>');\n         *  // e.g const service = app.getService('data/mysql.mydb');\n         * @memberof Runnable\n         */\n        getService(name) {\n            let pos = name.indexOf('/');\n            if (pos === -1) {\n                return super.getService(name);\n            }\n\n            let lib = name.substring(0, pos);\n            name = name.substring(pos + 1);\n\n            let app = this.getLib(lib);\n            return app?.getService(name, true);\n        }\n\n        _initialize() {\n            this._pwd = process.cwd();\n            if (this.workingPath !== this._pwd) {\n                process.chdir(this.workingPath);\n            }\n\n            this._injectErrorHandlers();\n        }\n\n        _uninitialize() {\n            const detach = true;\n            this._injectErrorHandlers(detach);\n\n            process.chdir(this._pwd);\n            delete this._pwd;\n        }\n\n        _injectErrorHandlers(detach) {\n            if (detach) {\n                process.removeListener('warning', this._onWarning);\n                if (this._onUncaughtException) {\n                    process.removeListener('uncaughtException', this._onUncaughtException);\n                    delete this._onUncaughtException;\n                }\n\n                return;\n            }\n\n            if (!this.options.ignoreUncaught) {\n                this._onUncaughtException = this._getOnUncaughtException(this.options.exitOnUncaught);\n                process.on('uncaughtException', this._onUncaughtException);\n            }\n\n            process.on('warning', this._onWarning);\n        }\n    };\n\nexport default Runnable;\n"],"names":["Runnable","T","start_","started","Error","_initialize","process","on","_onExit","error","code","message","JSON","stringify","info","options","logLevel","childModules","visitChildModules","childModule","name","features","Object","keys","services","log","modules","stop_","stopByThis","libModules","batchAsync_","lib","removeListener","sleep_","_uninitialize","vistor","_","each","getLib","libName","libModule","requireFromLib","relativePath","require","registerLib","InvalidConfiguration","getService","pos","indexOf","substring","app","_pwd","cwd","workingPath","chdir","_injectErrorHandlers","detach","_onWarning","_onUncaughtException","ignoreUncaught","_getOnUncaughtException","exitOnUncaught","constructor","defaultAppOpts","exitOnError","err","logError","warning","catch","runnable","libModulesPath","toAbsolutePath"],"mappings":"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"}