{"version":3,"sources":["../../lib/routers/module.js"],"sourcesContent":["import path from 'node:path';\nimport { _, url as urlUtil, text, esmCheck, batchAsync_ } from '@galaxar/utils';\nimport { InvalidConfiguration } from '@galaxar/types';\nimport { supportedMethods } from '../helpers';\n\n/**\n * Module router for mounting a specific controller.\n * @module Router_Module\n */\n\n/**\n * Create a module-based router.\n * @param {Routable} app\n * @param {string} baseRoute\n * @param {*} moduleItem\n * @example\n *   '<base path>': {\n *       module: {\n *           middlewares:\n *           controller:\n *       }\n *   }\n *\n *   '<base path>': {\n *       module: \"controller\"\n *   }\n */\nasync function moduleRouter(app, baseRoute, moduleItem) {\n    const Router = await app.tryRequire_('@koa/router');\n\n    let controllerPath = app.controllersPath;\n\n    if (typeof moduleItem === 'string') {\n        // [ 'controllerName' ]\n        moduleItem = {\n            controller: moduleItem,\n        };\n    }\n\n    let currentPrefix = urlUtil.join(baseRoute, moduleItem.route || '/');\n    let router = currentPrefix === '/' ? new Router() : new Router({ prefix: text.dropIfEndsWith(currentPrefix, '/') });\n\n    if (moduleItem.middlewares) {\n        //module-wide middlewares\n        await app.useMiddlewares_(router, moduleItem.middlewares);\n    }\n\n    let controllers;\n\n    if (moduleItem.controllers) {\n        controllers = moduleItem.controllers;\n        if (!Array.isArray(controllers)) {\n            throw new InvalidConfiguration(\n                'Invalid module router configuration: controllers must be an array.',\n                app,\n                `routing.${baseRoute}.module.controllers`\n            );\n        }\n    } else {\n        if (typeof moduleItem.controller !== 'string') {\n            throw new InvalidConfiguration(\n                'Invalid module router configuration: controller must be a string.',\n                app,\n                `routing.${baseRoute}.module.controller`\n            );\n        }\n\n        controllers = [moduleItem.controller];\n    }\n\n    await batchAsync_(controllers, async (moduleController) => {\n        let controllerFile = path.join(controllerPath, moduleController);\n        let controller;\n\n        try {\n            controller = esmCheck(require(controllerFile));\n        } catch (e) {\n            if (e.code === 'MODULE_NOT_FOUND') {\n                throw new InvalidConfiguration(\n                    `Failed to load controller '${moduleController}'. ${e.message}`,\n                    app,\n                    `routing.${baseRoute}.module`\n                );\n            }\n\n            throw e;\n        }\n\n        let isController = false;\n\n        if (typeof controller === 'function') {\n            controller = new controller(app);\n            isController = true;\n        }\n\n        for (let actionName in controller) {\n            let action = controller[actionName];\n            if (typeof action !== 'function' || !action.__metaHttpMethod) continue; // only marked httpMethod should be mounted\n\n            const method = action.__metaHttpMethod;\n            let subRoute = text.ensureStartsWith(action.__metaRoute || _.kebabCase(actionName), '/');\n\n            let bindAction;\n\n            if (isController) {\n                bindAction = action.bind(controller);\n            } else {\n                bindAction = action;\n            }\n\n            if (!supportedMethods.has(method)) {\n                throw new InvalidConfiguration(\n                    'Unsupported http method: ' + method,\n                    app,\n                    `routing.${baseRoute}.module ${moduleItem.controller}.${actionName}`\n                );\n            }\n\n            await app.addRoute_(\n                router,\n                method,\n                subRoute,\n                action.__metaMiddlewares ? action.__metaMiddlewares.concat([bindAction]) : bindAction\n            );\n        }\n    });\n\n    app.addRouter(router);\n}\n\nexport default moduleRouter;\n"],"names":["moduleRouter","app","baseRoute","moduleItem","Router","tryRequire_","controllerPath","controllersPath","controller","currentPrefix","urlUtil","join","route","router","prefix","text","dropIfEndsWith","middlewares","useMiddlewares_","controllers","Array","isArray","InvalidConfiguration","batchAsync_","moduleController","controllerFile","path","esmCheck","require","e","code","message","isController","actionName","action","__metaHttpMethod","method","subRoute","ensureStartsWith","__metaRoute","_","kebabCase","bindAction","bind","supportedMethods","has","addRoute_","__metaMiddlewares","concat","addRouter"],"mappings":";;;;+BAkIA;;;eAAA;;;iEAlIiB;uBAC8C;uBAC1B;yBACJ;;;;;;AAEjC;;;CAGC,GAED;;;;;;;;;;;;;;;;CAgBC,GACD,eAAeA,aAAaC,GAAG,EAAEC,SAAS,EAAEC,UAAU,EAAE;IACpD,MAAMC,SAAS,MAAMH,IAAII,WAAW,CAAC;IAErC,IAAIC,iBAAiBL,IAAIM,eAAe;IAExC,IAAI,OAAOJ,eAAe,UAAU;QAChC,uBAAuB;QACvBA,aAAa;YACTK,YAAYL;QAChB;IACJ,CAAC;IAED,IAAIM,gBAAgBC,UAAO,CAACC,IAAI,CAACT,WAAWC,WAAWS,KAAK,IAAI;IAChE,IAAIC,SAASJ,kBAAkB,MAAM,IAAIL,WAAW,IAAIA,OAAO;QAAEU,QAAQC,WAAI,CAACC,cAAc,CAACP,eAAe;IAAK,EAAE;IAEnH,IAAIN,WAAWc,WAAW,EAAE;QACxB,yBAAyB;QACzB,MAAMhB,IAAIiB,eAAe,CAACL,QAAQV,WAAWc,WAAW;IAC5D,CAAC;IAED,IAAIE;IAEJ,IAAIhB,WAAWgB,WAAW,EAAE;QACxBA,cAAchB,WAAWgB,WAAW;QACpC,IAAI,CAACC,MAAMC,OAAO,CAACF,cAAc;YAC7B,MAAM,IAAIG,2BAAoB,CAC1B,sEACArB,KACA,CAAC,QAAQ,EAAEC,UAAU,mBAAmB,CAAC,EAC3C;QACN,CAAC;IACL,OAAO;QACH,IAAI,OAAOC,WAAWK,UAAU,KAAK,UAAU;YAC3C,MAAM,IAAIc,2BAAoB,CAC1B,qEACArB,KACA,CAAC,QAAQ,EAAEC,UAAU,kBAAkB,CAAC,EAC1C;QACN,CAAC;QAEDiB,cAAc;YAAChB,WAAWK,UAAU;SAAC;IACzC,CAAC;IAED,MAAMe,IAAAA,kBAAW,EAACJ,aAAa,OAAOK,mBAAqB;QACvD,IAAIC,iBAAiBC,iBAAI,CAACf,IAAI,CAACL,gBAAgBkB;QAC/C,IAAIhB;QAEJ,IAAI;YACAA,aAAamB,IAAAA,eAAQ,EAACC,QAAQH;QAClC,EAAE,OAAOI,GAAG;YACR,IAAIA,EAAEC,IAAI,KAAK,oBAAoB;gBAC/B,MAAM,IAAIR,2BAAoB,CAC1B,CAAC,2BAA2B,EAAEE,iBAAiB,GAAG,EAAEK,EAAEE,OAAO,CAAC,CAAC,EAC/D9B,KACA,CAAC,QAAQ,EAAEC,UAAU,OAAO,CAAC,EAC/B;YACN,CAAC;YAED,MAAM2B,EAAE;QACZ;QAEA,IAAIG,eAAe,KAAK;QAExB,IAAI,OAAOxB,eAAe,YAAY;YAClCA,aAAa,IAAIA,WAAWP;YAC5B+B,eAAe,IAAI;QACvB,CAAC;QAED,IAAK,IAAIC,cAAczB,WAAY;YAC/B,IAAI0B,SAAS1B,UAAU,CAACyB,WAAW;YACnC,IAAI,OAAOC,WAAW,cAAc,CAACA,OAAOC,gBAAgB,EAAE,QAAS,EAAC,2CAA2C;YAEnH,MAAMC,SAASF,OAAOC,gBAAgB;YACtC,IAAIE,WAAWtB,WAAI,CAACuB,gBAAgB,CAACJ,OAAOK,WAAW,IAAIC,QAAC,CAACC,SAAS,CAACR,aAAa;YAEpF,IAAIS;YAEJ,IAAIV,cAAc;gBACdU,aAAaR,OAAOS,IAAI,CAACnC;YAC7B,OAAO;gBACHkC,aAAaR;YACjB,CAAC;YAED,IAAI,CAACU,yBAAgB,CAACC,GAAG,CAACT,SAAS;gBAC/B,MAAM,IAAId,2BAAoB,CAC1B,8BAA8Bc,QAC9BnC,KACA,CAAC,QAAQ,EAAEC,UAAU,QAAQ,EAAEC,WAAWK,UAAU,CAAC,CAAC,EAAEyB,WAAW,CAAC,EACtE;YACN,CAAC;YAED,MAAMhC,IAAI6C,SAAS,CACfjC,QACAuB,QACAC,UACAH,OAAOa,iBAAiB,GAAGb,OAAOa,iBAAiB,CAACC,MAAM,CAAC;gBAACN;aAAW,IAAIA,UAAU;QAE7F;IACJ;IAEAzC,IAAIgD,SAAS,CAACpC;AAClB;MAEA,WAAeb"}