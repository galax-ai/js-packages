{"version":3,"sources":["../../lib/routers/gaml.js"],"sourcesContent":["import path from 'node:path';\nimport { globSync } from 'glob';\nimport { _, naming, text, hasMethod, esmCheck } from '@galaxar/utils';\n\n/**\n * Galaxar API Modeling Language (GAML) router.\n * @module Router_Gaml\n */\n\nconst appendId = (baseEndpoint, idName) => (idName ? `${baseEndpoint}/:${idName}` : baseEndpoint);\n\n/**\n * Create a gaml router.\n * @param {*} app\n * @param {string} baseRoute\n * @param {object} options\n * @property {string} [options.resourcesPath]\n * @property {object|array} [options.middlewares]\n * @example\n *  '<base path>': {\n *      gaml: {\n *          resourcesPath:\n *          middlewares:\n *      }\n *  }\n *\n *  route                          http method    function of ctrl\n *  /:resource                     get            find\n *  /:resource                     post           post\n *  /:resource/:id                 get            findById\n *  /:resource/:id                 put            updateById\n *  /:resource/:id                 del            deleteById\n */\nconst gamlRouter = (app, baseRoute, options) => {\n    const Router = app.tryRequire('@koa/router');\n\n    let resourcePath = path.resolve(app.sourcePath, options.resourcesPath || 'resources');\n\n    let router = baseRoute === '/' ? new Router() : new Router({ prefix: text.dropIfEndsWith(baseRoute, '/') });\n\n    app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(options.errorOptions, app), 'jsonError');\n\n    if (options.middlewares) {\n        app.useMiddlewares(router, options.middlewares);\n    }\n\n    let resourcesPath = path.join(resourcePath, '**/*.js');\n    let files = globSync(resourcesPath);\n\n    _.each(files, (filepath) => {\n        let controller = esmCheck(require(filepath));\n\n        if (typeof controller === 'function') {\n            controller = new controller(app);\n        }\n\n        const relativePath = path.relative(resourcePath, filepath);\n        const dirPath = path.dirname(relativePath);\n        const entityName = path.basename(relativePath, '.js');\n        const entithNameWithPath = path.join(dirPath, entityName);\n\n        let baseEndpoint;\n        if (options.remaps && entithNameWithPath in options.remaps) {\n            baseEndpoint = text.ensureStartsWith(text.dropIfEndsWith(options.remaps[entithNameWithPath], '/'), '/');\n        } else {\n            const urlPath = entithNameWithPath\n                .split('/')\n                .map((p) => naming.kebabCase(p))\n                .join('/');\n            baseEndpoint = text.ensureStartsWith(urlPath, '/');\n        }\n\n        let idName = naming.camelCase(entityName) + 'Id';\n        let endpointWithId = appendId(baseEndpoint, idName);\n\n        if (hasMethod(controller, 'find')) {\n            const _action = controller.find.bind(controller);\n            const _middlewares = controller.find.__metaMiddlewares;\n            app.addRoute(router, 'get', baseEndpoint, _middlewares ? [..._middlewares, _action] : _action);\n        }\n\n        if (hasMethod(controller, 'post')) {\n            const _action = controller.post.bind(controller);\n            const _middlewares = controller.post.__metaMiddlewares;\n            app.addRoute(router, 'post', baseEndpoint, _middlewares ? [..._middlewares, _action] : _action);\n        }\n\n        if (hasMethod(controller, 'findById')) {\n            const _action = (ctx) => controller.findById(ctx, ctx.params[idName]);\n            const _middlewares = controller.findById.__metaMiddlewares;\n            app.addRoute(router, 'get', endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n        }\n\n        if (hasMethod(controller, 'updateById')) {\n            const _action = (ctx) => controller.updateById(ctx, ctx.params[idName]);\n            const _middlewares = controller.updateById.__metaMiddlewares;\n            app.addRoute(router, 'put', endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n        }\n\n        if (hasMethod(controller, 'deleteById')) {\n            const _action = (ctx) => controller.deleteById(ctx, ctx.params[idName]);\n            const _middlewares = controller.deleteById.__metaMiddlewares;\n            app.addRoute(router, 'del', endpointWithId, _middlewares ? [..._middlewares, _action] : _action);\n        }\n    });\n    app.addRouter(router);\n};\n\nexport default gamlRouter;\n"],"names":["appendId","baseEndpoint","idName","gamlRouter","app","baseRoute","options","Router","tryRequire","resourcePath","path","resolve","sourcePath","resourcesPath","router","prefix","text","dropIfEndsWith","useMiddleware","getMiddlewareFactory","errorOptions","middlewares","useMiddlewares","join","files","globSync","_","each","filepath","controller","esmCheck","require","relativePath","relative","dirPath","dirname","entityName","basename","entithNameWithPath","remaps","ensureStartsWith","urlPath","split","map","p","naming","kebabCase","camelCase","endpointWithId","hasMethod","_action","find","bind","_middlewares","__metaMiddlewares","addRoute","post","ctx","findById","params","updateById","deleteById","addRouter"],"mappings":"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"}