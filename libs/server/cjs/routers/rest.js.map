{"version":3,"sources":["../../lib/routers/rest.js"],"sourcesContent":["import path from 'node:path';\nimport { _, text, hasMethod, esmCheck } from '@galaxar/utils';\nimport { globSync } from 'glob';\n\n/**\n * RESTful router.\n * @module Router_Rest\n */\n\n/**\n * Create a RESTful router.\n * @param {*} app\n * @param {string} baseRoute\n * @param {objects} options\n * @property {string} [options.resourcesPath]\n * @property {object|array} [options.middlewares]\n * @example\n *  '<base path>': {\n *      rest: {\n *          resourcesPath:\n *          middlewares:\n *      }\n *  }\n *\n *  route                          http method    function of ctrl\n *  /:resource                     get            query\n *  /:resource                     post           create\n *  /:resource/:id                 get            detail\n *  /:resource/:id                 put            update\n *  /:resource/:id                 delete         remove\n */\nconst restRouter = (app, baseRoute, options) => {\n    const Router = app.tryRequire('@koa/router');\n\n    let resourcePath = path.resolve(app.sourcePath, options.resourcesPath ?? 'resources');\n\n    let router = baseRoute === '/' ? new Router() : new Router({ prefix: text.dropIfEndsWith(baseRoute, '/') });\n\n    app.useMiddleware(router, app.getMiddlewareFactory('jsonError')(options.errorOptions, app), 'jsonError');\n\n    if (options.middlewares) {\n        app.useMiddlewares(router, options.middlewares);\n    }\n\n    let resourcesPath = path.join(resourcePath, '**', '*.js');\n    let files = globSync(resourcesPath, { nodir: true });\n\n    _.each(files, (file) => {\n        let relPath = path.relative(resourcePath, file);\n        let batchUrl = text.ensureStartsWith(\n            relPath\n                .substring(0, relPath.length - 3)\n                .split(path.sep)\n                .map((p) => _.kebabCase(p))\n                .join('/'),\n            '/'\n        );\n        let singleUrl = batchUrl + '/:id';\n\n        let controller = esmCheck(require(file));\n\n        if (typeof controller === 'function') {\n            controller = new controller(app);\n        }\n\n        if (hasMethod(controller, 'query')) {\n            app.addRoute(router, 'get', batchUrl, (ctx) => controller.query(ctx));\n        }\n\n        if (hasMethod(controller, 'create')) {\n            app.addRoute(router, 'post', batchUrl, (ctx) => controller.create(ctx));\n        }\n\n        if (hasMethod(controller, 'detail')) {\n            app.addRoute(router, 'get', singleUrl, (ctx) => controller.detail(ctx));\n        }\n\n        if (hasMethod(controller, 'update')) {\n            app.addRoute(router, 'put', singleUrl, (ctx) => controller.update(ctx));\n        }\n\n        if (hasMethod(controller, 'remove')) {\n            app.addRoute(router, 'del', singleUrl, (ctx) => controller.remove(ctx));\n        }\n    });\n\n    app.addRouter(router);\n};\n\nexport default restRouter;\n"],"names":["restRouter","app","baseRoute","options","Router","tryRequire","resourcePath","path","resolve","sourcePath","resourcesPath","router","prefix","text","dropIfEndsWith","useMiddleware","getMiddlewareFactory","errorOptions","middlewares","useMiddlewares","join","files","globSync","nodir","_","each","file","relPath","relative","batchUrl","ensureStartsWith","substring","length","split","sep","map","p","kebabCase","singleUrl","controller","esmCheck","require","hasMethod","addRoute","ctx","query","create","detail","update","remove","addRouter"],"mappings":"oGAyFA,iDAAA,6DAzFiB,mCAC4B,sCACpB,4FA6BzB,MAAMA,WAAa,CAACC,IAAKC,UAAWC,UAAY,CAC5C,MAAMC,OAASH,IAAII,UAAU,CAAC,eAE9B,IAAIC,aAAeC,iBAAI,CAACC,OAAO,CAACP,IAAIQ,UAAU,CAAEN,QAAQO,aAAa,EAAI,aAEzE,IAAIC,OAAST,YAAc,IAAM,IAAIE,OAAW,IAAIA,OAAO,CAAEQ,OAAQC,WAAI,CAACC,cAAc,CAACZ,UAAW,IAAK,EAAE,CAE3GD,IAAIc,aAAa,CAACJ,OAAQV,IAAIe,oBAAoB,CAAC,aAAab,QAAQc,YAAY,CAAEhB,KAAM,aAE5F,GAAIE,QAAQe,WAAW,CAAE,CACrBjB,IAAIkB,cAAc,CAACR,OAAQR,QAAQe,WAAW,CAClD,CAAC,AAED,IAAIR,cAAgBH,iBAAI,CAACa,IAAI,CAACd,aAAc,KAAM,QAClD,IAAIe,MAAQC,GAAAA,cAAQ,EAACZ,cAAe,CAAEa,MAAO,IAAI,AAAC,GAElDC,QAAC,CAACC,IAAI,CAACJ,MAAO,AAACK,MAAS,CACpB,IAAIC,QAAUpB,iBAAI,CAACqB,QAAQ,CAACtB,aAAcoB,MAC1C,IAAIG,SAAWhB,WAAI,CAACiB,gBAAgB,CAChCH,QACKI,SAAS,CAAC,EAAGJ,QAAQK,MAAM,CAAG,GAC9BC,KAAK,CAAC1B,iBAAI,CAAC2B,GAAG,EACdC,GAAG,CAAC,AAACC,GAAMZ,QAAC,CAACa,SAAS,CAACD,IACvBhB,IAAI,CAAC,KACV,KAEJ,IAAIkB,UAAYT,SAAW,OAE3B,IAAIU,WAAaC,GAAAA,eAAQ,EAACC,QAAQf,OAElC,GAAI,OAAOa,aAAe,WAAY,CAClCA,WAAa,IAAIA,WAAWtC,IAChC,CAAC,AAED,GAAIyC,GAAAA,gBAAS,EAACH,WAAY,SAAU,CAChCtC,IAAI0C,QAAQ,CAAChC,OAAQ,MAAOkB,SAAU,AAACe,KAAQL,WAAWM,KAAK,CAACD,KACpE,CAAC,AAED,GAAIF,GAAAA,gBAAS,EAACH,WAAY,UAAW,CACjCtC,IAAI0C,QAAQ,CAAChC,OAAQ,OAAQkB,SAAU,AAACe,KAAQL,WAAWO,MAAM,CAACF,KACtE,CAAC,AAED,GAAIF,GAAAA,gBAAS,EAACH,WAAY,UAAW,CACjCtC,IAAI0C,QAAQ,CAAChC,OAAQ,MAAO2B,UAAW,AAACM,KAAQL,WAAWQ,MAAM,CAACH,KACtE,CAAC,AAED,GAAIF,GAAAA,gBAAS,EAACH,WAAY,UAAW,CACjCtC,IAAI0C,QAAQ,CAAChC,OAAQ,MAAO2B,UAAW,AAACM,KAAQL,WAAWS,MAAM,CAACJ,KACtE,CAAC,AAED,GAAIF,GAAAA,gBAAS,EAACH,WAAY,UAAW,CACjCtC,IAAI0C,QAAQ,CAAChC,OAAQ,MAAO2B,UAAW,AAACM,KAAQL,WAAWU,MAAM,CAACL,KACtE,CAAC,AACL,GAEA3C,IAAIiD,SAAS,CAACvC,OAClB,QAEA,SAAeX"}