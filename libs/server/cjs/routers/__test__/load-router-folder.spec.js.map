{"version":3,"sources":["../../../lib/routers/__test__/load-router-folder.spec.js"],"sourcesContent":["\n'use strict';\n\nconst path = require('path');\nconst { fs } = require('@galaxar/sys');\nconst request = require('supertest');\nconst assert = require('assert');\nconst WebServer = require('../../WebServer');\n\nconst WORKING_DIR = path.resolve(__dirname, '../../../test/temp');\n\n/**目录结构\n* -resources\n*    book1.js\n*    me\n*     book2.js\n*     info\n*       book3.js \n*       book6.js\n*       detail\n*         book4.js\n*         book5.js\n*/\n\nconst book1JS = `\n class Controller {\n     async find(ctx) {\n         ctx.body = 'book1';\n     };\n }\n module.exports = Controller;\n `;\n\nconst book2JS = `\n class Controller {\n     async find(ctx) {\n         ctx.body = 'book2';\n     };\n }\n module.exports = Controller;\n `;\n\nconst book3JS = `\n class Controller {\n     async post(ctx) {\n         ctx.body = 'book3';\n     };\n }\n module.exports = Controller;\n `;\n\nconst book4JS = `\n class Controller {\n     async findById(ctx,bookId) {\n         ctx.body = 'book4-id:' + bookId;\n     };\n\n     async updateById(ctx,bookId) {\n        ctx.body = 'book4-id:' + bookId;\n    };\n }\n module.exports = Controller;\n `;\n\n const book5JS = `\n class Controller {\n     async find(ctx) {\n        ctx.body = 'book5';\n     };\n }\n module.exports = Controller;\n `;\n\n const book6JS = `\n class Controller {\n     async find(ctx) {\n        ctx.body = 'book6';\n     };\n\n     async updateById(ctx,book6Id) {\n        ctx.body = 'book6-id:' + book6Id;\n     };\n }\n module.exports = Controller;\n `;\n\ndescribe('unit:router:load-router', async function () {\n    let webServer;\n\n    before(async function () {\n        fs.emptyDirSync(WORKING_DIR);\n        let resourcesPath = path.join(WORKING_DIR, 'server', 'resources');\n        fs.ensureDirSync(resourcesPath);\n\n        fs.writeFileSync(path.join(resourcesPath, 'book1.js'), book1JS);\n\n        fs.ensureDirSync(resourcesPath + '/me');\n        fs.writeFileSync(path.join(resourcesPath, 'me/book2.js'), book2JS);\n\n        fs.ensureDirSync(resourcesPath + '/me/info');\n        fs.writeFileSync(path.join(resourcesPath, 'me/info/book3.js'), book3JS);\n        fs.writeFileSync(path.join(resourcesPath, 'me/info/book6.js'), book6JS);\n\n        fs.ensureDirSync(resourcesPath + '/me/info/detail');\n        fs.writeFileSync(path.join(resourcesPath, 'me/info/detail/book4.js'), book4JS);\n        fs.writeFileSync(path.join(resourcesPath, 'me/info/detail/book5.js'), book5JS);\n\n        webServer = new WebServer('test server', {\n            workingPath: WORKING_DIR,\n            logger: {\n                level: 'verbose'\n            }\n        });\n\n        webServer.once('configLoaded', () => {\n            webServer.config = {\n                \"koa\": {\n                },\n                \"middlewares\": [\n                    \"koa-body\",\n                    \"koa-override\"\n                ],\n                \"routing\": {\n                    \"/api\": {\n                        \"gaml\": {\n                            \"remaps\": {\n                                \"me/info/detail/book4\": \"/book4\",\n                                \"me/info/book6\":\"/user/:userId/book6\"\n                            }\n                        }\n                    }\n                }\n            };\n        });\n\n        return webServer.start_();\n\n    });\n\n    describe(\"loader router\", async function () {\n        it('/api/book-1', function (done) {\n            request(webServer.httpServer)\n                .get('/api/book-1')\n                .set('Accept', 'application/json')\n                .expect(200)\n                .then(res => {\n                    assert(res.text, 'book1');\n                    done()\n                }).catch(err => done(err))\n        });\n\n        it('GET:/api/me/book-2', function (done) {\n            request(webServer.httpServer)\n                .get('/api/me/book-2')\n                .set('Accept', 'application/json')\n                .expect(200)\n                .then(res => {\n                    assert(res.text, 'book2-id:1');\n                    done();\n                }).catch(err => done(err))\n\n        });\n\n        it('POST:/api/me/info/book-3', function (done) {\n            request(webServer.httpServer)\n                .post('/api/me/info/book-3')\n                .set('Accept', 'application/json')\n                .expect(200)\n                .then(res => {\n                    assert(res.text, 'book3');\n                    done();\n                }).catch(err => done(err))\n        });\n\n        it('remaps GET:/api/book4', function (done) {\n            request(webServer.httpServer)\n                .get('/api/book4/1')\n                .set('Accept', 'application/json')\n                .expect(200)\n                .then(res => {\n                    assert(res.text, 'book4-id:1');\n                    done();\n                }).catch(err => done(err))\n        });\n\n        it('remaps PUT:/api/book4', function (done) {\n            request(webServer.httpServer)\n                .put('/api/book4/1')\n                .set('Accept', 'application/json')\n                .expect(200)\n                .then(res => {\n                    assert(res.text, 'book4-id:1');\n                    done();\n                }).catch(err => done(err))\n        });\n\n        it('remaps PUT:/api/book4', function (done) {\n            request(webServer.httpServer)\n                .put('/api/book4/1')\n                .set('Accept', 'application/json')\n                .expect(200)\n                .then(res => {\n                    assert(res.text, 'book4-id:1');\n                    done();\n                }).catch(err => done(err))\n        });\n\n        it('GET:/api/me/:meId/info/detail/book-5', function (done) {\n            request(webServer.httpServer)\n                .get('/api/me/info/detail/book-5')\n                .set('Accept', 'application/json')\n                .expect(200)\n                .then(res => {\n                    assert(res.text, 'book5-id:1');\n                    done();\n                }).catch(err => done(err))\n        });\n\n        it('remaps GET:/api/user/:userId/book6', function (done) {\n            request(webServer.httpServer)\n                .get('/api/user/6/book6')\n                .set('Accept', 'application/json')\n                .expect(200)\n                .then(res => {\n                    assert(res.text, 'book6-id:6');\n                    done();\n                }).catch(err => done(err))\n        });\n\n        it('remaps PUT:/api/user/:userId/book6/:book6Id', function (done) {\n            request(webServer.httpServer)\n                .put('/api/user/6/book6/6')\n                .set('Accept', 'application/json')\n                .expect(200)\n                .then(res => {\n                    assert(res.text, 'book6-id:6-book:6');\n                    done();\n                }).catch(err => done(err))\n        });\n    })\n\n    after(async function () {\n        await webServer.stop_();\n        fs.removeSync(WORKING_DIR);\n    });\n\n\n\n    after(async function () {\n\n    });\n\n});"],"names":["path","require","fs","request","assert","WebServer","WORKING_DIR","resolve","__dirname","book1JS","book2JS","book3JS","book4JS","book5JS","book6JS","describe","webServer","before","emptyDirSync","resourcesPath","join","ensureDirSync","writeFileSync","workingPath","logger","level","once","config","start_","it","done","httpServer","get","set","expect","then","res","text","catch","err","post","put","after","stop_","removeSync"],"mappings":"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"}