{"version":3,"sources":["../../../lib/routers/__test__/gaml-class.spec.js"],"sourcesContent":["'use strict';\n\nconst path = require('path');\nconst request = require('supertest');\nconst { fs } = require('@genx/sys');\nconst WebServer = require('../../WebServer');\n\nconst WORKING_DIR = path.resolve(__dirname, '../../../test/temp');\n\nlet resourceBook = `\nconst { _ } = require('@genx/july');\n\nlet books = [ { id: 1, title: 'Book 1' }, { id: 2, title: 'Book 2' } ];\nlet maxid = 2;\n\nclass Controller {\n    async find(ctx) {\n        ctx.body = books;\n    };\n\n    async post(ctx) {\n        let newBook = {id: ++maxid, title: ctx.request.body.title};\n        books.push(newBook);\n        ctx.body = newBook;\n    };\n\n    async findById(ctx, id) {\n        ctx.body =  _.find(books, book => book.id == id) || {};\n    };\n\n    async updateById(ctx, id) {\n        let bookFound = _.find(books, book => book.id == id);\n\n        bookFound.title = ctx.request.body.title;\n        ctx.body =  bookFound;\n    };\n\n    async deleteById(ctx, id) {\n        let idx = _.findIndex(books, book => book.id == id);\n        ctx.body = books.splice(idx, 1)[0];\n    };\n}\n\nmodule.exports = Controller;\n`;\n\ndescribe('unit:router:gaml-class', function () {\n    let webServer;\n\n    before(async function () {\n        fs.emptyDirSync(WORKING_DIR);\n        let resourcesPath = path.join(WORKING_DIR, 'server', 'resources');\n        fs.ensureDirSync(resourcesPath);\n        fs.writeFileSync(path.join(resourcesPath, 'book.js'), resourceBook);\n\n        webServer = new WebServer('test server', {\n            workingPath: WORKING_DIR,\n            logger: {\n                level: 'verbose'\n            }\n        });\n\n        webServer.once('configLoaded', () => {\n            webServer.config = {\n                \"koa\": {\n                },\n                \"middlewares\": [\n                    \"koa-body\",\n                    \"koa-override\"\n                ],\n                \"routing\": {\n                    \"/api\": {\n                        \"gaml\": {}\n                    }\n                }\n            };\n        });\n\n        return webServer.start_();\n    });\n\n    after(async function () {\n        await webServer.stop_();\n        fs.removeSync(WORKING_DIR);\n    });\n\n    describe('class function', function () {\n        it('should get a list of books', function (done) {\n            request(webServer.httpServer)\n                .get('/api/book')\n                .set('Accept', 'application/json')\n                .expect('Content-Type', /json/)\n                .expect(200)\n                .expect(function (res) {\n                    if (!Array.isArray(res.body)) {\n                        return 'Result is not a list';\n                    }\n\n                    if (res.body.length !== 2) {\n                        return 'Unexpected result';\n                    }\n                })\n                .end(done);\n        });\n        it('should add a new book', function (done) {\n            request(webServer.httpServer)\n                .post('/api/book')\n                .send({ title: 'Avatar' })\n                .set('Accept', 'application/json')\n                .expect('Content-Type', /json/)\n                .expect(200)\n                .expect({ id: 3, title: 'Avatar' })\n                .end(done);\n        });\n        it('should get book 2 successfully', function (done) {\n            request(webServer.httpServer)\n                .get('/api/book/2')\n                .set('Accept', 'application/json')\n                .expect('Content-Type', /json/)\n                .expect(200)\n                .expect({ id: 2, title: 'Book 2' })\n                .end(done);\n        });\n        it('should update book 2 successfully', function (done) {\n            request(webServer.httpServer)\n                .put('/api/book/2')\n                .send({ title: 'Brave Cross' })\n                .set('Accept', 'application/json')\n                .expect('Content-Type', /json/)\n                .expect(200)\n                .expect({ id: 2, title: 'Brave Cross' })\n                .end(done);\n        });\n        it('should delete book 2 successfully', async function () {\n            await request(webServer.httpServer)\n                .del('/api/book/2')\n                .set('Accept', 'application/json')\n                .expect('Content-Type', /json/)\n                .expect(200)\n                .expect({ id: 2, title: 'Brave Cross' });\n\n            await request(webServer.httpServer)\n                .get('/api/book/2')\n                .set('Accept', 'application/json')\n                .expect('Content-Type', /json/)\n                .expect(200)\n                .expect({});            \n        });\n        it('should return 404', function (done) {\n            request(webServer.httpServer)\n                .get('/api/non_exist/1')\n                .set('Accept', 'application/json')\n                .expect('Content-Type', 'text/plain; charset=utf-8')\n                .expect(404)\n                .end(done);\n        });\n    });\n});"],"names":["path","require","request","fs","WebServer","WORKING_DIR","resolve","__dirname","resourceBook","describe","webServer","before","emptyDirSync","resourcesPath","join","ensureDirSync","writeFileSync","workingPath","logger","level","once","config","start_","after","stop_","removeSync","it","done","httpServer","get","set","expect","res","Array","isArray","body","length","end","post","send","title","id","put","del"],"mappings":"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"}