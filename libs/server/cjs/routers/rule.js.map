{"version":3,"sources":["../../lib/routers/rule.js"],"sourcesContent":["\"use strict\";\n\nconst { _, text } = require(\"@genx/july\");\nconst Router = require(\"@koa/router\");\nconst { InvalidConfiguration } = require(\"@genx/error\");\nconst Literal = require(\"../enum/Literal\");\n\n/**\n * Rule based router.\n * @module Router_Rule\n */\n\n/**\n * Create a rule-based router.\n * @param {WebModule} app\n * @param {string} baseRoute\n * @param {object} options\n * @example\n * '<base path>': {\n *     rule: {\n *         middlewares:\n *         rules: {\n *             // type 1, default is \"get\", methods mapped to one action\n *             '<sub route>': '<controller with relative path>.<action>',\n *\n *             // type 2, different methods mapped to different method\n *             '<sub route>': {\n *                '<method>': '<controller with relative path>.<action>'\n *             },\n *\n *             // type 3, with middleware\n *             '<sub route>': {\n *                 '<method>': {\n *                    '<middleware name>': { //middleware options }\n *                 }\n *             },\n *\n *             // type 4, all methods mapped to one action\n *             '<method>:/<sub route>': '<controller with relative path>.<action>'\n *\n *             // type 5, all methods mapped to one action\n *             '<method>:/<sub route>': {\n *                 '<middleware name>': { //middleware options }\n *             }\n *         }\n *     }\n * }\n */\nfunction load_(app, baseRoute, options) {\n    let router = baseRoute === \"/\" ? new Router() : new Router({ prefix: text.dropIfEndsWith(baseRoute, \"/\") });\n\n    if (options.middlewares) {\n        app.useMiddlewares(router, options.middlewares);\n    }\n\n    _.forOwn(options.rules || {}, (methods, subRoute) => {\n        let pos = subRoute.indexOf(\":/\");\n\n        if (pos !== -1) {\n            if (pos === 0) {\n                throw new InvalidConfiguration(\n                    \"Invalid route rule syntax: \" + subRoute,\n                    app,\n                    `routing[${baseRoute}].rule.rules`\n                );\n            }\n\n            // like get:/, or post:/\n\n            let embeddedMethod = subRoute.substr(0, pos).toLocaleLowerCase();\n            subRoute = subRoute.substr(pos + 2);\n\n            methods = { [embeddedMethod]: methods };\n        }\n\n        subRoute = text.ensureStartsWith(subRoute, \"/\");\n\n        if (typeof methods === \"string\" || Array.isArray(methods)) {\n            methods = { get: methods };\n        }\n\n        _.forOwn(methods, (middlewares, method) => {\n            if (!Literal.ALLOWED_HTTP_METHODS.has(method) && method !== \"all\") {\n                throw new InvalidConfiguration(\n                    \"Unsupported http method: \" + method,\n                    app,\n                    `routing[${baseRoute}].rule.rules[${subRoute}]`\n                );\n            }\n\n            app.addRoute(router, method, subRoute, middlewares);\n        });\n    });\n\n    app.addRouter(router);\n}\n\nmodule.exports = load_;\n"],"names":["_","text","require","Router","InvalidConfiguration","Literal","load_","app","baseRoute","options","router","prefix","dropIfEndsWith","middlewares","useMiddlewares","forOwn","rules","methods","subRoute","pos","indexOf","embeddedMethod","substr","toLocaleLowerCase","ensureStartsWith","Array","isArray","get","method","ALLOWED_HTTP_METHODS","has","addRoute","addRouter","module","exports"],"mappings":"AAAA,aAEA,KAAM,CAAEA,CAAC,CAAEC,IAAI,CAAE,CAAGC,QAAQ,cAC5B,MAAMC,OAASD,QAAQ,eACvB,KAAM,CAAEE,oBAAoB,CAAE,CAAGF,QAAQ,eACzC,MAAMG,QAAUH,QAAQ,mBA2CxB,SAASI,MAAMC,GAAG,CAAEC,SAAS,CAAEC,OAAO,CAAE,CACpC,IAAIC,OAASF,YAAc,IAAM,IAAIL,OAAW,IAAIA,OAAO,CAAEQ,OAAQV,KAAKW,cAAc,CAACJ,UAAW,IAAK,EAAE,CAE3G,GAAIC,QAAQI,WAAW,CAAE,CACrBN,IAAIO,cAAc,CAACJ,OAAQD,QAAQI,WAAW,CAClD,CAAC,AAEDb,EAAEe,MAAM,CAACN,QAAQO,KAAK,EAAI,CAAC,EAAG,CAACC,QAASC,WAAa,CACjD,IAAIC,IAAMD,SAASE,OAAO,CAAC,MAE3B,GAAID,MAAQ,CAAC,EAAG,CACZ,GAAIA,MAAQ,EAAG,CACX,MAAM,IAAIf,qBACN,8BAAgCc,SAChCX,IACA,CAAC,QAAQ,EAAEC,UAAU,YAAY,CAAC,CACpC,AACN,CAAC,AAID,IAAIa,eAAiBH,SAASI,MAAM,CAAC,EAAGH,KAAKI,iBAAiB,GAC9DL,SAAWA,SAASI,MAAM,CAACH,IAAM,GAEjCF,QAAU,CAAE,CAACI,eAAe,CAAEJ,OAAQ,CAC1C,CAAC,AAEDC,SAAWjB,KAAKuB,gBAAgB,CAACN,SAAU,KAE3C,GAAI,OAAOD,UAAY,UAAYQ,MAAMC,OAAO,CAACT,SAAU,CACvDA,QAAU,CAAEU,IAAKV,OAAQ,CAC7B,CAAC,AAEDjB,EAAEe,MAAM,CAACE,QAAS,CAACJ,YAAae,SAAW,CACvC,GAAI,CAACvB,QAAQwB,oBAAoB,CAACC,GAAG,CAACF,SAAWA,SAAW,MAAO,CAC/D,MAAM,IAAIxB,qBACN,4BAA8BwB,OAC9BrB,IACA,CAAC,QAAQ,EAAEC,UAAU,aAAa,EAAEU,SAAS,CAAC,CAAC,CACjD,AACN,CAAC,AAEDX,IAAIwB,QAAQ,CAACrB,OAAQkB,OAAQV,SAAUL,YAC3C,EACJ,GAEAN,IAAIyB,SAAS,CAACtB,OAClB,CAEAuB,OAAOC,OAAO,CAAG5B"}