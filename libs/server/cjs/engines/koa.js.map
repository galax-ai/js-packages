{"version":3,"sources":["../../lib/engines/koa.js"],"sourcesContent":["import http from 'node:http';\nimport Koa from 'koa';\nimport mount from 'koa-mount';\nimport { _, toBoolean } from '@galaxar/utils';\nimport { InvalidConfiguration } from '@galaxar/types';\n\nclass KoaEngine {\n    constructor(server) {\n        this.server = server;\n        this.engine = new Koa();\n\n        if (this.server.runnable) {\n            this.server.on('configFinalized', (config) => {\n                const koaConfig = config.koa;\n\n                this._initialize({ ...koaConfig });\n\n                delete config.koa;\n            });\n        }\n    }\n\n    _initialize(options) {\n        const koa = this.engine;\n        const server = this.server;\n        koa.proxy = options.trustProxy && toBoolean(options.trustProxy);\n\n        if (options.subdomainOffset != null) {\n            if (options.subdomainOffset < 2) {\n                throw new InvalidConfiguration(\n                    'Invalid subdomainOffset. Should be larger or equal to 2.',\n                    this.server,\n                    'koa.subdomainOffset'\n                );\n            }\n\n            koa.subdomainOffset = options.subdomainOffset;\n        }\n\n        if (options.keys) {\n            koa.keys = _.castArray(options.keys);\n        }\n\n        koa.on('error', (err, ctx) => {\n            const info = { err, app: ctx.appModule.name };\n\n            if (err.status && err.status < 500) {\n                if (ctx.log) {\n                    ctx.log.warn(info);\n                } else {\n                    ctx.appModule.log('warn', 'REQUEST ERROR', info);\n                }\n\n                return;\n            }\n\n            if (ctx.log) {\n                ctx.log.error(info);\n            } else {\n                ctx.appModule.log('error', 'SERVER ERROR', info);\n            }\n        });\n\n        server.httpServer = http.createServer(koa.callback());\n\n        let port = options.httpPort || 2331;\n\n        server.on('ready', () => {\n            server.httpServer.listen(port, function (err) {\n                if (err) throw err;\n\n                let address = server.httpServer.address();\n\n                let host;\n                if (address.family === 'IPv6' && address.address === '::') {\n                    host = '127.0.0.1';\n                } else {\n                    host = address.address;\n                }\n\n                server.host = `${host}:${address.port}`;\n                server.port = address.port;\n\n                server.log('info', `A http service is listening on port [${address.port}] ...`);\n                /**\n                 * Http server ready event\n                 * @event WebServer#httpReady\n                 */\n                server.emit_('httpReady', server);\n            });\n        });\n    }\n\n    use(middleware) {\n        this.engine.use(middleware);\n    }\n\n    mount(route, subEngine) {\n        this.engine.use(mount(route, subEngine.engine));\n    }\n\n    middleware(fn) {\n        return fn;\n    }\n}\n\nexport default KoaEngine;\n"],"names":["KoaEngine","_initialize","options","koa","engine","server","proxy","trustProxy","toBoolean","subdomainOffset","InvalidConfiguration","keys","_","castArray","on","err","ctx","info","app","appModule","name","status","log","warn","error","httpServer","http","createServer","callback","port","httpPort","listen","address","host","family","emit_","use","middleware","mount","route","subEngine","fn","constructor","Koa","runnable","config","koaConfig"],"mappings":"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"}