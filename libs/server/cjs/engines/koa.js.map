{"version":3,"sources":["../../lib/engines/koa.js"],"sourcesContent":["import Koa from 'koa';\nimport mount from 'koa-mount';\nimport { _, toBoolean } from '@galaxar/utils';\n\nclass KoaEngine {\n    constructor(server) {\n        this.server = server;\n        this.engine = new Koa();\n\n        console.log('feiojfioajfiewajiofjo');\n\n        if (this.server.runnable) {\n            console.log('8888888');\n\n            this.server.on('configFinalized', (config) => {\n                console.log('foiejfieaofjoefoj');\n                const koaConfig = config.koa;\n\n                if (!koaConfig) {\n                    throw new InvalidConfiguration('Missing koa config.', this.server, 'koa');\n                }\n\n                this._initialize(koaConfig);\n\n                delete config.koa;\n            });\n        }\n    }\n\n    _initialize(options) {\n        const koa = this.engine;\n        const server = this.server;\n        koa.proxy = options.trustProxy && toBoolean(options.trustProxy);\n\n        if (options.subdomainOffset != null) {\n            if (options.subdomainOffset < 2) {\n                throw new InvalidConfiguration(\n                    'Invalid subdomainOffset. Should be larger or equal to 2.',\n                    this.server,\n                    'koa.subdomainOffset'\n                );\n            }\n\n            koa.subdomainOffset = options.subdomainOffset;\n        }\n\n        if (options.keys) {\n            koa.keys = _.castArray(options.keys);\n        }\n\n        koa.on('error', (err, ctx) => {\n            let extra = _.pick(err, ['status', 'code', 'info']);\n\n            if (ctx) {\n                extra.request = _.pick(ctx, ['method', 'url', 'ip']);\n            }\n\n            extra.app = ctx.appModule.name;\n\n            if (err.status && err.status < 500) {\n                if (server.env === 'development') {\n                    extra.stack = err.stack;\n                }\n                server.log('warn', `[${err.status}] ` + err.message, extra);\n                return;\n            }\n\n            server.logError(err);\n        });\n\n        server.httpServer = require('http').createServer(koa.callback());\n\n        let port = options.httpPort || 2331;\n\n        server.on('ready', () => {\n            server.httpServer.listen(port, function (err) {\n                if (err) throw err;\n\n                let address = server.httpServer.address();\n\n                let host;\n                if (address.family === 'IPv6' && address.address === '::') {\n                    host = '127.0.0.1';\n                } else {\n                    host = address.address;\n                }\n\n                server.host = `${host}:${address.port}`;\n                server.port = address.port;\n\n                server.log('info', `A http service is listening on port [${address.port}] ...`);\n                /**\n                 * Http server ready event\n                 * @event WebServer#httpReady\n                 */\n                server.emit_('httpReady', server);\n            });\n        });\n    }\n\n    use(middleware) {\n        this.engine.use(middleware);\n    }\n\n    mount(route, subEngine) {\n        this.engine.use(mount(route, subEngine));\n    }\n\n    middleware(fn) {\n        return fn;\n    }\n}\n\nexport default KoaEngine;\n"],"names":["KoaEngine","_initialize","options","koa","engine","server","proxy","trustProxy","toBoolean","subdomainOffset","InvalidConfiguration","keys","_","castArray","on","err","ctx","extra","pick","request","app","appModule","name","status","env","stack","log","message","logError","httpServer","require","createServer","callback","port","httpPort","listen","address","host","family","emit_","use","middleware","mount","route","subEngine","fn","constructor","Koa","console","runnable","config","koaConfig"],"mappings":"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"}