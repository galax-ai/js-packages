{"version":3,"sources":["../../lib/engines/koa.js"],"sourcesContent":["import Koa from 'koa';\nimport mount from 'koa-mount';\nimport { _, toBoolean } from '@galaxar/utils';\nimport { InvalidConfiguration } from '@galaxar/types';\n\nclass KoaEngine {\n    constructor(server) {\n        this.server = server;\n        this.engine = new Koa();\n\n        if (this.server.runnable) {\n            this.server.on('configFinalized', (config) => {\n                const koaConfig = config.koa;\n\n                this._initialize({ ...koaConfig });\n\n                delete config.koa;\n            });\n        }\n    }\n\n    _initialize(options) {\n        const koa = this.engine;\n        const server = this.server;\n        koa.proxy = options.trustProxy && toBoolean(options.trustProxy);\n\n        if (options.subdomainOffset != null) {\n            if (options.subdomainOffset < 2) {\n                throw new InvalidConfiguration(\n                    'Invalid subdomainOffset. Should be larger or equal to 2.',\n                    this.server,\n                    'koa.subdomainOffset'\n                );\n            }\n\n            koa.subdomainOffset = options.subdomainOffset;\n        }\n\n        if (options.keys) {\n            koa.keys = _.castArray(options.keys);\n        }\n\n        koa.on('error', (err, ctx) => {\n            const info = { err, app: ctx.appModule.name };\n\n            if (err.status && err.status < 500) {\n                if (ctx.log) {\n                    ctx.log('warn', info);\n                } else {\n                    ctx.appModule.log('warn', info);\n                }\n                \n                return;\n            }\n\n            if (ctx.log) {\n                ctx.log('error', info);\n            } else {\n                ctx.appModule.log('error', info);\n            }            \n        });\n\n        server.httpServer = require('http').createServer(koa.callback());\n\n        let port = options.httpPort || 2331;\n\n        server.on('ready', () => {\n            server.httpServer.listen(port, function (err) {\n                if (err) throw err;\n\n                let address = server.httpServer.address();\n\n                let host;\n                if (address.family === 'IPv6' && address.address === '::') {\n                    host = '127.0.0.1';\n                } else {\n                    host = address.address;\n                }\n\n                server.host = `${host}:${address.port}`;\n                server.port = address.port;\n\n                server.log('info', `A http service is listening on port [${address.port}] ...`);\n                /**\n                 * Http server ready event\n                 * @event WebServer#httpReady\n                 */\n                server.emit_('httpReady', server);\n            });\n        });\n    }\n\n    use(middleware) {\n        this.engine.use(middleware);\n    }\n\n    mount(route, subEngine) {\n        this.engine.use(mount(route, subEngine));\n    }\n\n    middleware(fn) {\n        return fn;\n    }\n}\n\nexport default KoaEngine;\n"],"names":["KoaEngine","_initialize","options","koa","engine","server","proxy","trustProxy","toBoolean","subdomainOffset","InvalidConfiguration","keys","_","castArray","on","err","ctx","info","app","appModule","name","status","log","httpServer","require","createServer","callback","port","httpPort","listen","address","host","family","emit_","use","middleware","mount","route","subEngine","fn","constructor","Koa","runnable","config","koaConfig"],"mappings":"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"}