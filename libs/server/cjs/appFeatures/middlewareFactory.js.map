{"version":3,"sources":["../../lib/appFeatures/middlewareFactory.js"],"sourcesContent":["/**\n * Enable middleware factory\n * @module Feature_MiddlewareFactory\n *\n * @example\n *   \"middlewareFactory\": {\n *       //new middleware name\n *       \"listOfMiddleware\": {\n *           \"middleware1\": { // options\n *               ...\n *           },\n *           \"middleware2\": { // options\n *               ...\n *           }\n *       },\n *        \"altListOfMiddleware\": [\n *           {\n *               \"name\": \"middleware1\",\n *               \"options\": { ... }\n *           },\n *           [ \"middleware2\", { ... } ],\n *           \"middleware3\"\n *       ]\n *   },\n */\n\nimport { _, isPlainObject } from '@galaxar/utils';\nimport { Feature } from '@galaxar/app';\nimport { InvalidConfiguration } from '@galaxar/types';\n\nexport default {\n    /**\n     * This feature is loaded at init stage\n     * @member {string}\n     */\n    stage: Feature.INIT,\n\n    /**\n     * Load the feature\n     * @param {App} app - The app module object\n     * @param {object} factories - Object factories\n     * @returns {Promise.<*>}\n     */\n    load_: (app, factories) => {\n        _.each(factories, (factoryInfo, name) => {\n            app.registerMiddlewareFactory(name, (opt, targetApp) => {\n                if (!_.isEmpty(opt)) {\n                    throw new InvalidConfiguration(\n                        'Middleware factory should be used with empty options.',\n                        app,\n                        `middlewareFactory.${name}`\n                    );\n                }\n\n                let chains;\n\n                if (isPlainObject(factoryInfo)) {\n                    chains = [];\n\n                    _.each(factoryInfo, (options, middleware) => {\n                        chains.push(app.getMiddlewareFactory(middleware)(options, targetApp));\n                    });\n                } else if (Array.isArray(factoryInfo)) {\n                    chains = factoryInfo.map((middlewareInfo, i) => {\n                        if (isPlainObject(middlewareInfo)) {\n                            if (!middlewareInfo.name) {\n                                throw new InvalidConfiguration(\n                                    'Missing referenced middleware name.',\n                                    app,\n                                    `middlewareFactory.${name}[${i}].name`\n                                );\n                            }\n\n                            return app.getMiddlewareFactory(middlewareInfo.name)(middlewareInfo.options, targetApp);\n                        }\n\n                        if (Array.isArray(middlewareInfo)) {\n                            if (\n                                middlewareInfo.length < 1 ||\n                                middlewareInfo.length > 2 ||\n                                typeof middlewareInfo[0] !== 'string'\n                            ) {\n                                throw new InvalidConfiguration(\n                                    'Invalid middleware factory item config.',\n                                    app,\n                                    `middlewareFactory.${name}[${i}]`\n                                );\n                            }\n\n                            return app.getMiddlewareFactory(middlewareInfo[0])(\n                                middlewareInfo.length > 1 ? middlewareInfo[1] : undefined,\n                                targetApp\n                            );\n                        }\n\n                        if (typeof middlewareInfo === 'string') {\n                            return app.getMiddlewareFactory(middlewareInfo)(undefined, targetApp);\n                        }\n\n                        throw new InvalidConfiguration(\n                            'Invalid middleware factory item config.',\n                            app,\n                            `middlewareFactory.${name}[${i}]`\n                        );\n                    });\n                } else {\n                    throw new InvalidConfiguration(\n                        'Invalid middleware factory config.',\n                        app,\n                        `middlewareFactory.${name}`\n                    );\n                }\n\n                return chains.length === 1 ? chains[0] : chains;\n            });\n        });\n    },\n};\n"],"names":["stage","Feature","INIT","load_","app","factories","_","each","factoryInfo","name","registerMiddlewareFactory","opt","targetApp","isEmpty","InvalidConfiguration","chains","isPlainObject","options","middleware","push","getMiddlewareFactory","Array","isArray","map","middlewareInfo","i","length","undefined"],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;CAwBC;;;;+BAMD;;;eAAA;;;uBAJiC;qBACT;uBACa;MAErC,WAAe;IACX;;;KAGC,GACDA,OAAOC,YAAO,CAACC,IAAI;IAEnB;;;;;KAKC,GACDC,OAAO,CAACC,KAAKC,YAAc;QACvBC,QAAC,CAACC,IAAI,CAACF,WAAW,CAACG,aAAaC,OAAS;YACrCL,IAAIM,yBAAyB,CAACD,MAAM,CAACE,KAAKC,YAAc;gBACpD,IAAI,CAACN,QAAC,CAACO,OAAO,CAACF,MAAM;oBACjB,MAAM,IAAIG,2BAAoB,CAC1B,yDACAV,KACA,CAAC,kBAAkB,EAAEK,KAAK,CAAC,EAC7B;gBACN,CAAC;gBAED,IAAIM;gBAEJ,IAAIC,IAAAA,oBAAa,EAACR,cAAc;oBAC5BO,SAAS,EAAE;oBAEXT,QAAC,CAACC,IAAI,CAACC,aAAa,CAACS,SAASC,aAAe;wBACzCH,OAAOI,IAAI,CAACf,IAAIgB,oBAAoB,CAACF,YAAYD,SAASL;oBAC9D;gBACJ,OAAO,IAAIS,MAAMC,OAAO,CAACd,cAAc;oBACnCO,SAASP,YAAYe,GAAG,CAAC,CAACC,gBAAgBC,IAAM;wBAC5C,IAAIT,IAAAA,oBAAa,EAACQ,iBAAiB;4BAC/B,IAAI,CAACA,eAAef,IAAI,EAAE;gCACtB,MAAM,IAAIK,2BAAoB,CAC1B,uCACAV,KACA,CAAC,kBAAkB,EAAEK,KAAK,CAAC,EAAEgB,EAAE,MAAM,CAAC,EACxC;4BACN,CAAC;4BAED,OAAOrB,IAAIgB,oBAAoB,CAACI,eAAef,IAAI,EAAEe,eAAeP,OAAO,EAAEL;wBACjF,CAAC;wBAED,IAAIS,MAAMC,OAAO,CAACE,iBAAiB;4BAC/B,IACIA,eAAeE,MAAM,GAAG,KACxBF,eAAeE,MAAM,GAAG,KACxB,OAAOF,cAAc,CAAC,EAAE,KAAK,UAC/B;gCACE,MAAM,IAAIV,2BAAoB,CAC1B,2CACAV,KACA,CAAC,kBAAkB,EAAEK,KAAK,CAAC,EAAEgB,EAAE,CAAC,CAAC,EACnC;4BACN,CAAC;4BAED,OAAOrB,IAAIgB,oBAAoB,CAACI,cAAc,CAAC,EAAE,EAC7CA,eAAeE,MAAM,GAAG,IAAIF,cAAc,CAAC,EAAE,GAAGG,SAAS,EACzDf;wBAER,CAAC;wBAED,IAAI,OAAOY,mBAAmB,UAAU;4BACpC,OAAOpB,IAAIgB,oBAAoB,CAACI,gBAAgBG,WAAWf;wBAC/D,CAAC;wBAED,MAAM,IAAIE,2BAAoB,CAC1B,2CACAV,KACA,CAAC,kBAAkB,EAAEK,KAAK,CAAC,EAAEgB,EAAE,CAAC,CAAC,EACnC;oBACN;gBACJ,OAAO;oBACH,MAAM,IAAIX,2BAAoB,CAC1B,sCACAV,KACA,CAAC,kBAAkB,EAAEK,KAAK,CAAC,EAC7B;gBACN,CAAC;gBAED,OAAOM,OAAOW,MAAM,KAAK,IAAIX,MAAM,CAAC,EAAE,GAAGA,MAAM;YACnD;QACJ;IACJ;AACJ"}