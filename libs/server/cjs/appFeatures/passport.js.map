{"version":3,"sources":["../../lib/appFeatures/passport.js"],"sourcesContent":["/**\n * Enable passport feature\n * @module Feature_Passport\n */\n\nimport path from 'node:path';\nimport { Feature } from '@galaxar/app';\nimport { batchAsync_, esmCheck } from '@galaxar/utils';\n\nexport default {\n    /**\n     * This feature is loaded at service stage\n     * @member {string}\n     */\n    stage: Feature.SERVICE,\n\n    /**\n     * Load the feature\n     * @param {Routable} app - The app module object\n     * @param {object} config - Passport settings\n     * @property {bool} [config.useSession=false] - Use session or not, default: false\n     *\n     * @property {object} config.init - Passport initialization settings\n     * @property {string} [config.init.userProperty='user'] - User property name, default: user\n     *\n     * @property {array} config.strategies - Passport strategies, e.g. [ 'local', 'facebook' ]\n     * @property {array} config.shareToServer - Expose the passport servcie to while server\n     * @returns {Promise.<*>}\n     */\n    load_: function (app, options, name) {\n        const { strategies, useSession, init, shareToServer } =\n            app.featureConfig(\n                options,\n                {\n                    schema: {\n                        strategies: {\n                            type: 'array',\n                            elementSchema: { type: 'text' },\n                        },\n                        useSession: { type: 'bool', default: false },\n                        init: { type: 'object', optional: true },\n                        shareToServer: { type: 'bool', default: false },\n                    },\n                },\n                name\n            );\n\n        const KoaPassport = app.tryRequire('koa-passport').KoaPassport;\n        const passport = new KoaPassport();\n\n        let initializeMiddleware = passport.initialize(init);\n\n        passport.middlewares = useSession\n            ? [initializeMiddleware, passport.session()]\n            : initializeMiddleware;\n\n        app.on('before:' + Feature.FINAL, async () => {\n            await app.useMiddlewares_(app.router, passport.middlewares);\n        });\n\n        passport.hasStrategy = (name) => {\n            return name in passport._strategies;\n        };\n\n        app.registerService(name, passport);\n\n        if (shareToServer && app.host != null) {\n            app.host.registerService(name, passport);\n        }\n\n        return batchAsync_(strategies, async (strategy) => {\n            const strategyScript = path.join(\n                app.sourcePath,\n                'passports',\n                strategy\n            );\n            const strategyInitiator = esmCheck(require(strategyScript));\n            return strategyInitiator(app, passport);\n        });\n    },\n};\n"],"names":["stage","Feature","SERVICE","load_","app","options","name","strategies","useSession","init","shareToServer","featureConfig","schema","type","elementSchema","default","optional","KoaPassport","tryRequire","passport","initializeMiddleware","initialize","middlewares","session","on","FINAL","useMiddlewares_","router","hasStrategy","_strategies","registerService","host","batchAsync_","strategy","strategyScript","path","join","sourcePath","strategyInitiator","esmCheck","require"],"mappings":"AAAA;;;CAGC;;;;+BAMD;;;eAAA;;;iEAJiB;qBACO;uBACc;;;;;;MAEtC,WAAe;IACX;;;KAGC,GACDA,OAAOC,YAAO,CAACC,OAAO;IAEtB;;;;;;;;;;;;KAYC,GACDC,OAAO,SAAUC,GAAG,EAAEC,OAAO,EAAEC,IAAI,EAAE;QACjC,MAAM,EAAEC,WAAU,EAAEC,WAAU,EAAEC,KAAI,EAAEC,cAAa,EAAE,GACjDN,IAAIO,aAAa,CACbN,SACA;YACIO,QAAQ;gBACJL,YAAY;oBACRM,MAAM;oBACNC,eAAe;wBAAED,MAAM;oBAAO;gBAClC;gBACAL,YAAY;oBAAEK,MAAM;oBAAQE,SAAS,KAAK;gBAAC;gBAC3CN,MAAM;oBAAEI,MAAM;oBAAUG,UAAU,IAAI;gBAAC;gBACvCN,eAAe;oBAAEG,MAAM;oBAAQE,SAAS,KAAK;gBAAC;YAClD;QACJ,GACAT;QAGR,MAAMW,cAAcb,IAAIc,UAAU,CAAC,gBAAgBD,WAAW;QAC9D,MAAME,WAAW,IAAIF;QAErB,IAAIG,uBAAuBD,SAASE,UAAU,CAACZ;QAE/CU,SAASG,WAAW,GAAGd,aACjB;YAACY;YAAsBD,SAASI,OAAO;SAAG,GAC1CH,oBAAoB;QAE1BhB,IAAIoB,EAAE,CAAC,YAAYvB,YAAO,CAACwB,KAAK,EAAE,UAAY;YAC1C,MAAMrB,IAAIsB,eAAe,CAACtB,IAAIuB,MAAM,EAAER,SAASG,WAAW;QAC9D;QAEAH,SAASS,WAAW,GAAG,CAACtB,OAAS;YAC7B,OAAOA,QAAQa,SAASU,WAAW;QACvC;QAEAzB,IAAI0B,eAAe,CAACxB,MAAMa;QAE1B,IAAIT,iBAAiBN,IAAI2B,IAAI,IAAI,IAAI,EAAE;YACnC3B,IAAI2B,IAAI,CAACD,eAAe,CAACxB,MAAMa;QACnC,CAAC;QAED,OAAOa,IAAAA,kBAAW,EAACzB,YAAY,OAAO0B,WAAa;YAC/C,MAAMC,iBAAiBC,iBAAI,CAACC,IAAI,CAC5BhC,IAAIiC,UAAU,EACd,aACAJ;YAEJ,MAAMK,oBAAoBC,IAAAA,eAAQ,EAACC,QAAQN;YAC3C,OAAOI,kBAAkBlC,KAAKe;QAClC;IACJ;AACJ"}