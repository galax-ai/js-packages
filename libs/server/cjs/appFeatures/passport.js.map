{"version":3,"sources":["../../lib/appFeatures/passport.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Enable passport feature\n * @module Feature_Passport\n */\n\nconst path = require('path');\nconst { _, eachAsync_ } = require('@galaxar/utils');\nconst { Feature } = require('..').Enums;\nconst { InvalidConfiguration } = require('@galaxar/types');\n\nmodule.exports = {\n\n    /**\n     * This feature is loaded at service stage\n     * @member {string}\n     */\n    type: Feature.SERVICE,\n\n    /**\n     * Load the feature\n     * @param {Routable} app - The app module object\n     * @param {object} config - Passport settings\n     * @property {bool} [config.useSession=false] - Use session or not, default: false\n     *  \n     * @property {object} config.init - Passport initialization settings     \n     * @property {string} [config.init.userProperty='user'] - User property name, default: user      \n     * \n     * @property {array} config.strategies - Passport strategies, e.g. [ 'local', 'facebook' ]\n     * @property {array} config.exposeToServer - Expose the passport servcie to while server\n     * @returns {Promise.<*>}\n     */\n    load_: function (app, config) {\n        const KoaPassport = app.tryRequire('koa-passport').KoaPassport;\n        let passport = new KoaPassport();\n        if (_.isEmpty(config) || _.isEmpty(config.strategies)) {\n            throw new InvalidConfiguration(\n                'Missing passport strategies.',\n                app,\n                'passport.strategies'\n            );\n        }        \n\n        let initializeMiddleware = passport.initialize(config.init);\n\n        passport.middlewares = config.useSession ? [ initializeMiddleware, passport.session() ] : initializeMiddleware;\n\n        app.on('before:' + Feature.FINAL, () => {\n            app.useMiddlewares(app.router, passport.middlewares);\n        });\n\n        passport.hasStrategy = (name) => {\n            return name in passport._strategies;\n        };\n\n        app.registerService('passport', passport);        \n\n        if (config.exposeToServer && app !== app.server) {\n            app.server.registerService('passport', passport);\n        }\n\n        let strategies = Array.isArray(config.strategies) ? config.strategies : [ config.strategies ];\n\n        return eachAsync_(strategies, async strategy => {\n            let strategyScript = path.join(app.backendPath, 'passports', strategy + '.js');\n            let strategyInitiator = require(strategyScript);\n            return strategyInitiator(app, passport);\n        });\n    }\n};"],"names":["path","require","_","eachAsync_","Feature","Enums","InvalidConfiguration","module","exports","type","SERVICE","load_","app","config","KoaPassport","tryRequire","passport","isEmpty","strategies","initializeMiddleware","initialize","init","middlewares","useSession","session","on","FINAL","useMiddlewares","router","hasStrategy","name","_strategies","registerService","exposeToServer","server","Array","isArray","strategy","strategyScript","join","backendPath","strategyInitiator"],"mappings":"AAAA,aAOA,MAAMA,KAAOC,QAAQ,QACrB,KAAM,CAAEC,CAAC,CAAEC,UAAU,CAAE,CAAGF,QAAQ,kBAClC,KAAM,CAAEG,OAAO,CAAE,CAAGH,QAAQ,MAAMI,KAAK,CACvC,KAAM,CAAEC,oBAAoB,CAAE,CAAGL,QAAQ,iBAEzCM,CAAAA,OAAOC,OAAO,CAAG,CAMbC,KAAML,QAAQM,OAAO,CAerBC,MAAO,SAAUC,GAAG,CAAEC,MAAM,CAAE,CAC1B,MAAMC,YAAcF,IAAIG,UAAU,CAAC,gBAAgBD,WAAW,CAC9D,IAAIE,SAAW,IAAIF,YACnB,GAAIZ,EAAEe,OAAO,CAACJ,SAAWX,EAAEe,OAAO,CAACJ,OAAOK,UAAU,EAAG,CACnD,MAAM,IAAIZ,qBACN,+BACAM,IACA,sBACF,AACN,CAAC,AAED,IAAIO,qBAAuBH,SAASI,UAAU,CAACP,OAAOQ,IAAI,CAE1DL,CAAAA,SAASM,WAAW,CAAGT,OAAOU,UAAU,CAAG,CAAEJ,qBAAsBH,SAASQ,OAAO,GAAI,CAAGL,oBAAoB,CAE9GP,IAAIa,EAAE,CAAC,UAAYrB,QAAQsB,KAAK,CAAE,IAAM,CACpCd,IAAIe,cAAc,CAACf,IAAIgB,MAAM,CAAEZ,SAASM,WAAW,CACvD,EAEAN,CAAAA,SAASa,WAAW,CAAG,AAACC,MAAS,CAC7B,OAAOA,QAAQd,SAASe,WAAW,AACvC,EAEAnB,IAAIoB,eAAe,CAAC,WAAYhB,UAEhC,GAAIH,OAAOoB,cAAc,EAAIrB,MAAQA,IAAIsB,MAAM,CAAE,CAC7CtB,IAAIsB,MAAM,CAACF,eAAe,CAAC,WAAYhB,SAC3C,CAAC,AAED,IAAIE,WAAaiB,MAAMC,OAAO,CAACvB,OAAOK,UAAU,EAAIL,OAAOK,UAAU,CAAG,CAAEL,OAAOK,UAAU,CAAE,CAE7F,OAAOf,WAAWe,WAAY,MAAMmB,UAAY,CAC5C,IAAIC,eAAiBtC,KAAKuC,IAAI,CAAC3B,IAAI4B,WAAW,CAAE,YAAaH,SAAW,OACxE,IAAII,kBAAoBxC,QAAQqC,gBAChC,OAAOG,kBAAkB7B,IAAKI,SAClC,EACJ,CACJ"}