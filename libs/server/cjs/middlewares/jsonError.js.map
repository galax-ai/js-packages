{"version":3,"sources":["../../lib/middlewares/jsonError.js"],"sourcesContent":["/**\n * Error response middleware with json\n * @module Middleware_JsonError\n */\n\nimport http from 'node:http';\n\nconst jsonError = (opt, app) => {\n    const apiWrapper = app.getService(app.settings?.apiWrapperService || 'apiWrapper');\n    const handler = apiWrapper && apiWrapper.wrapError;\n\n    return async (ctx, next) => {\n        try {\n            await next();\n\n            if (ctx.errorHandled) {\n                return;\n            }\n\n            if (ctx.status >= 400) {\n                if (ctx.type === 'text/plain') {\n                    ctx.throw(ctx.status, ctx.body);\n                } else {\n                    ctx.throw(ctx.status);\n                }\n            }\n        } catch (err) {\n            ctx.status = typeof err.status === 'number' && err.status >= 100 ? err.status : 500;\n            ctx.type = 'application/json';\n\n            // accepted types\n            if (handler) {\n                try {\n                    ctx.body = await handler(ctx, err);\n                    ctx.app.emit('error', err, ctx);\n                    ctx.errorHandled = true;\n                    return;\n                } catch (error) {\n                    error.innerError = err;\n                    err = error;\n                }\n            }\n\n            ctx.body = { error: err.expose && err.message ? err.message : http.STATUS_CODES[ctx.status] };\n            ctx.app.emit('error', err, ctx);\n        }\n    };\n};\n\nexport default jsonError;\n"],"names":["jsonError","opt","app","apiWrapper","getService","settings","apiWrapperService","handler","wrapError","ctx","next","errorHandled","status","type","throw","body","err","emit","error","innerError","expose","message","http","STATUS_CODES"],"mappings":"oGAiDA,iDAAA,6DA5CiB,kGAEjB,MAAMA,UAAY,CAACC,IAAKC,MAAQ,CAC5B,MAAMC,WAAaD,IAAIE,UAAU,CAACF,IAAIG,QAAQ,EAAEC,mBAAqB,cACrE,MAAMC,QAAUJ,YAAcA,WAAWK,SAAS,CAElD,OAAO,MAAOC,IAAKC,OAAS,CACxB,GAAI,CACA,MAAMA,OAEN,GAAID,IAAIE,YAAY,CAAE,CAClB,MACJ,CAAC,AAED,GAAIF,IAAIG,MAAM,EAAI,IAAK,CACnB,GAAIH,IAAII,IAAI,GAAK,aAAc,CAC3BJ,IAAIK,KAAK,CAACL,IAAIG,MAAM,CAAEH,IAAIM,IAAI,CAClC,KAAO,CACHN,IAAIK,KAAK,CAACL,IAAIG,MAAM,CACxB,CAAC,AACL,CAAC,AACL,CAAE,MAAOI,IAAK,CACVP,IAAIG,MAAM,CAAG,OAAOI,IAAIJ,MAAM,GAAK,UAAYI,IAAIJ,MAAM,EAAI,IAAMI,IAAIJ,MAAM,CAAG,GAAG,AACnFH,CAAAA,IAAII,IAAI,CAAG,mBAGX,GAAIN,QAAS,CACT,GAAI,CACAE,IAAIM,IAAI,CAAG,MAAMR,QAAQE,IAAKO,KAC9BP,IAAIP,GAAG,CAACe,IAAI,CAAC,QAASD,IAAKP,IAC3BA,CAAAA,IAAIE,YAAY,CAAG,IAAI,CACvB,MACJ,CAAE,MAAOO,MAAO,CACZA,MAAMC,UAAU,CAAGH,IACnBA,IAAME,KACV,CACJ,CAAC,AAEDT,IAAIM,IAAI,CAAG,CAAEG,MAAOF,IAAII,MAAM,EAAIJ,IAAIK,OAAO,CAAGL,IAAIK,OAAO,CAAGC,iBAAI,CAACC,YAAY,CAACd,IAAIG,MAAM,CAAC,AAAC,EAC5FH,IAAIP,GAAG,CAACe,IAAI,CAAC,QAASD,IAAKP,IAC/B,CACJ,CACJ,QAEA,SAAeT"}