{"version":3,"sources":["../../lib/middlewares/favicon.js"],"sourcesContent":["/**\n * Middleware to serve favicon request.\n * @module Middleware_Favicon\n */\n\nimport { _ } from \"@galaxar/utils\";\nimport { fs } from \"@galaxar/sys\";\nimport path from \"node:path\";\nimport { HttpCode, InvalidConfiguration } from \"@galaxar/types\";\n\nconst favicon = (options, app) => {\n    if (typeof options === 'string') {\n        options = { path: options };\n    } \n    \n    let faviconPath = options && options.path && app.toAbsolutePath(options.path) || path.join(app.publicPath, 'favicon.ico');\n    if (!fs.existsSync(faviconPath)) {\n        throw new InvalidConfiguration(\n            `Favicon path \"${faviconPath}\" not exists.`,\n            app,\n            'middlewares.favicon'\n        );\n    }   \n\n    let icon;\n    const maxAge = options.maxAge == null\n        ? 86400000\n        : Math.min(Math.max(0, options.maxAge), 31556926000);\n    const cacheControl = `public, max-age=${maxAge / 1000 | 0}`;\n\n    return async (ctx, next) => {\n        if ('/favicon.ico' !== ctx.path || ('GET' !== ctx.method && 'HEAD' !== ctx.method)) {\n            return next();\n        }\n\n        if (!icon) {\n            let stats = await fs.stat(faviconPath);\n            //maximum 1M\n            if (stats.size > 1048576) {\n                app.log('warn', 'favicon.ico too large.', stats);\n                ctx.throw(HttpCode.NOT_FOUND);                \n            }\n            \n            icon = await fs.readFile(faviconPath);\n        }\n        ctx.set('Cache-Control', cacheControl);\n        ctx.type = 'image/x-icon';\n        ctx.body = icon;\n    };\n};\n\nexport default favicon;"],"names":["favicon","options","app","path","faviconPath","toAbsolutePath","join","publicPath","fs","existsSync","InvalidConfiguration","icon","maxAge","Math","min","max","cacheControl","ctx","next","method","stats","stat","size","log","throw","HttpCode","NOT_FOUND","readFile","set","type","body"],"mappings":"oGAmDA,iDAAA,iCA9CkB,qCACC,iEACF,mCAC8B,sGAE/C,MAAMA,QAAU,CAACC,QAASC,MAAQ,CAC9B,GAAI,OAAOD,UAAY,SAAU,CAC7BA,QAAU,CAAEE,KAAMF,OAAQ,CAC9B,CAAC,AAED,IAAIG,YAAcH,SAAWA,QAAQE,IAAI,EAAID,IAAIG,cAAc,CAACJ,QAAQE,IAAI,GAAKA,iBAAI,CAACG,IAAI,CAACJ,IAAIK,UAAU,CAAE,eAC3G,GAAI,CAACC,OAAE,CAACC,UAAU,CAACL,aAAc,CAC7B,MAAM,IAAIM,2BAAoB,CAC1B,CAAC,cAAc,EAAEN,YAAY,aAAa,CAAC,CAC3CF,IACA,sBACF,AACN,CAAC,AAED,IAAIS,KACJ,MAAMC,OAASX,QAAQW,MAAM,EAAI,IAAI,CAC/B,MACAC,KAAKC,GAAG,CAACD,KAAKE,GAAG,CAAC,EAAGd,QAAQW,MAAM,EAAG,WAAY,CACxD,MAAMI,aAAe,CAAC,gBAAgB,EAAEJ,OAAS,IAAO,EAAE,CAAC,CAE3D,OAAO,MAAOK,IAAKC,OAAS,CACxB,GAAI,iBAAmBD,IAAId,IAAI,EAAK,QAAUc,IAAIE,MAAM,EAAI,SAAWF,IAAIE,MAAM,CAAG,CAChF,OAAOD,MACX,CAAC,AAED,GAAI,CAACP,KAAM,CACP,IAAIS,MAAQ,MAAMZ,OAAE,CAACa,IAAI,CAACjB,aAE1B,GAAIgB,MAAME,IAAI,CAAG,QAAS,CACtBpB,IAAIqB,GAAG,CAAC,OAAQ,yBAA0BH,OAC1CH,IAAIO,KAAK,CAACC,eAAQ,CAACC,SAAS,CAChC,CAAC,AAEDf,KAAO,MAAMH,OAAE,CAACmB,QAAQ,CAACvB,YAC7B,CAAC,AACDa,IAAIW,GAAG,CAAC,gBAAiBZ,aACzBC,CAAAA,IAAIY,IAAI,CAAG,cACXZ,CAAAA,IAAIa,IAAI,CAAGnB,IACf,CACJ,QAEA,SAAeX"}