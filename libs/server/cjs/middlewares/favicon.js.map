{"version":3,"sources":["../../lib/middlewares/favicon.js"],"sourcesContent":["/**\n * Middleware to serve favicon request.\n * @module Middleware_Favicon\n */\n\nimport { _ } from '@galaxar/utils';\nimport { fs } from '@galaxar/sys';\nimport path from 'node:path';\nimport { HttpCode, InvalidConfiguration } from '@galaxar/types';\n\nconst favicon = (options, app) => {\n    if (typeof options === 'string') {\n        options = { path: options };\n    }\n\n    let faviconPath =\n        (options && options.path && app.toAbsolutePath(options.path)) || path.join(app.publicPath, 'favicon.ico');\n    if (!fs.existsSync(faviconPath)) {\n        throw new InvalidConfiguration(`Favicon path \"${faviconPath}\" not exists.`, app, 'middlewares.favicon');\n    }\n\n    let icon;\n    const maxAge = options.maxAge == null ? 86400000 : Math.min(Math.max(0, options.maxAge), 31556926000);\n    const cacheControl = `public, max-age=${(maxAge / 1000) | 0}`;\n\n    return async (ctx, next) => {\n        if ('/favicon.ico' !== ctx.path || ('GET' !== ctx.method && 'HEAD' !== ctx.method)) {\n            return next();\n        }\n\n        if (!icon) {\n            let stats = await fs.stat(faviconPath);\n            //maximum 1M\n            if (stats.size > 1048576) {\n                app.log('warn', 'favicon.ico too large.', stats);\n                ctx.throw(HttpCode.NOT_FOUND);\n            }\n\n            icon = await fs.readFile(faviconPath);\n        }\n        ctx.set('Cache-Control', cacheControl);\n        ctx.type = 'image/x-icon';\n        ctx.body = icon;\n    };\n};\n\nexport default favicon;\n"],"names":["favicon","options","app","path","faviconPath","toAbsolutePath","join","publicPath","fs","existsSync","InvalidConfiguration","icon","maxAge","Math","min","max","cacheControl","ctx","next","method","stats","stat","size","log","throw","HttpCode","NOT_FOUND","readFile","set","type","body"],"mappings":"AAAA;;;CAGC;;;;+BA2CD;;;eAAA;;;uBAzCkB;qBACC;iEACF;uBAC8B;;;;;;AAE/C,MAAMA,UAAU,CAACC,SAASC,MAAQ;IAC9B,IAAI,OAAOD,YAAY,UAAU;QAC7BA,UAAU;YAAEE,MAAMF;QAAQ;IAC9B,CAAC;IAED,IAAIG,cACA,AAACH,WAAWA,QAAQE,IAAI,IAAID,IAAIG,cAAc,CAACJ,QAAQE,IAAI,KAAMA,iBAAI,CAACG,IAAI,CAACJ,IAAIK,UAAU,EAAE;IAC/F,IAAI,CAACC,OAAE,CAACC,UAAU,CAACL,cAAc;QAC7B,MAAM,IAAIM,2BAAoB,CAAC,CAAC,cAAc,EAAEN,YAAY,aAAa,CAAC,EAAEF,KAAK,uBAAuB;IAC5G,CAAC;IAED,IAAIS;IACJ,MAAMC,SAASX,QAAQW,MAAM,IAAI,IAAI,GAAG,WAAWC,KAAKC,GAAG,CAACD,KAAKE,GAAG,CAAC,GAAGd,QAAQW,MAAM,GAAG,YAAY;IACrG,MAAMI,eAAe,CAAC,gBAAgB,EAAE,AAACJ,SAAS,OAAQ,EAAE,CAAC;IAE7D,OAAO,OAAOK,KAAKC,OAAS;QACxB,IAAI,mBAAmBD,IAAId,IAAI,IAAK,UAAUc,IAAIE,MAAM,IAAI,WAAWF,IAAIE,MAAM,EAAG;YAChF,OAAOD;QACX,CAAC;QAED,IAAI,CAACP,MAAM;YACP,IAAIS,QAAQ,MAAMZ,OAAE,CAACa,IAAI,CAACjB;YAC1B,YAAY;YACZ,IAAIgB,MAAME,IAAI,GAAG,SAAS;gBACtBpB,IAAIqB,GAAG,CAAC,QAAQ,0BAA0BH;gBAC1CH,IAAIO,KAAK,CAACC,eAAQ,CAACC,SAAS;YAChC,CAAC;YAEDf,OAAO,MAAMH,OAAE,CAACmB,QAAQ,CAACvB;QAC7B,CAAC;QACDa,IAAIW,GAAG,CAAC,iBAAiBZ;QACzBC,IAAIY,IAAI,GAAG;QACXZ,IAAIa,IAAI,GAAGnB;IACf;AACJ;MAEA,WAAeX"}