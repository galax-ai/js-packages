{"version":3,"sources":["../../lib/serverFeatures/appRouting.js"],"sourcesContent":["/**\n * Enable routing web requests to a child app.\n * @module Feature_AppRouting\n *\n * @example\n *\n *  'appRouting': {\n *      '<mounting point>': {\n *          name: 'app name',\n *          npmModule: false, // whether is a npm module\n *          options: { // module options\n *          },\n *          settings: { // can override module defined settings\n *          },\n *          middlewares: { // can override middlewares\n *          }\n *      }\n *  }\n */\n\nimport path from 'node:path';\nimport { _, batchAsync_ } from '@galaxar/utils';\nimport { fs, isDir_ } from '@galaxar/sys';\nimport { InvalidConfiguration } from '@galaxar/types';\nimport { Feature } from '@galaxar/app';\n\nimport WebModule from '../WebModule';\n\nexport default {\n    /**\n     * This feature is loaded at plugin stage.\n     * @member {string}\n     */\n    stage: Feature.PLUGIN,\n\n    /**\n     * Load the feature.\n     * @param {WebServer} server - The web server module object.\n     * @param {object} routes - Routes and configuration.\n     * @returns {Promise.<*>}\n     */\n    load_: async (server, routes) =>\n        batchAsync_(routes, async (config, baseRoute) => {\n            if (!config.name) {\n                throw new InvalidConfiguration('Missing app name.', app, `appRouting.${baseRoute}.name`);\n            }\n\n            let options = {\n                env: server.env,\n                logLevel: server.options.logLevel,\n                traceMiddlewares: server.options.traceMiddlewares,\n                ...config.options,\n            };\n\n            let appPath;\n\n            if (config.npmModule) {\n                appPath = server.toAbsolutePath('node_modules', config.name);\n            } else {\n                appPath = path.join(server.appModulesPath, config.name);\n            }\n\n            let exists = (await fs.pathExists(appPath)) && (await isDir_(appPath));\n            if (!exists) {\n                throw new InvalidConfiguration(\n                    `App [${config.name}] not found at ${appPath}`,\n                    server,\n                    `appRouting.${baseRoute}.name`\n                );\n            }\n\n            let app = new WebModule(server, config.name, baseRoute, appPath, options);\n            app.now = server.now;\n\n            app.on('configLoaded', () => {\n                if (!_.isEmpty(config.overrides)) {\n                    Object.assign(app.config, config.overrides);\n                    server.log('verbose', 'App config is overrided.');\n                }\n\n                if (!_.isEmpty(config.settings)) {\n                    app.config.settings = Object.assign({}, app.config.settings, config.settings);\n                    server.log('verbose', `App settings of [${app.name}] is overrided.`);\n                }\n\n                if (!_.isEmpty(config.middlewares)) {\n                    let middlewaresToAppend = app.config.middlewares;\n                    app.config.middlewares = { ...config.middlewares };\n                    _.defaults(app.config.middlewares, middlewaresToAppend);\n                }\n            });\n\n            let relativePath = path.relative(server.workingPath, appPath);\n            server.log('verbose', `Loading app [${app.name}] from \"${relativePath}\" ...`);\n\n            await app.start_();\n\n            server.log('verbose', `App [${app.name}] is loaded.`);\n\n            //delayed the app routes mounting after all plugins of the server are loaded\n            server.on('before:' + Feature.FINAL, () => {\n                server.mountApp(app);\n            });\n        }),\n};\n"],"names":["stage","Feature","PLUGIN","load_","server","routes","batchAsync_","config","baseRoute","name","InvalidConfiguration","app","options","env","logLevel","traceMiddlewares","appPath","npmModule","toAbsolutePath","path","join","appModulesPath","exists","fs","pathExists","isDir_","WebModule","now","on","_","isEmpty","overrides","Object","assign","log","settings","middlewares","middlewaresToAppend","defaults","relativePath","relative","workingPath","start_","FINAL","mountApp"],"mappings":"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"}