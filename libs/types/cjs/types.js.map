{"version":3,"sources":["../lib/types.js"],"sourcesContent":["import { InvalidArgument, ValidationError, ApplicationError } from './errors';\n\nlet counter = 0;\n\nconst defaultTypeClasses = [];\nconst defaultPlugins = [];\n\nexport class TypeSystem {\n    primitives = new Set();\n    scalarTypes = new Set();\n    plugins = {};\n    types = {};\n    sanitize = this.callType('sanitize');\n    sanitize_ = this.callType('sanitize_');\n    serialize = this.callType('serialize');\n\n    constructor() {\n        this._counter = counter++;\n    }\n\n    static fromDefault() {\n        const ts = new TypeSystem();\n\n        defaultTypeClasses.forEach(({ name, TypeMeta }) => {\n            ts.addType(name, TypeMeta);\n        });\n\n        defaultPlugins.forEach(({ name, plugin }) => {\n            ts.addPlugin(name, plugin);\n        });\n\n        return ts;\n    }\n\n    addPlugin(name, plugin) {\n        this.plugins[name] = plugin;\n    }\n\n    removePlugin(name) {\n        delete this.plugins[name];\n    }\n\n    _addType(name, typeMeta) {\n        if (name in this.types) {\n            throw new ApplicationError(`Type \"${name}\" already exist.`, { name });\n        }\n\n        this.types[name] = typeMeta;\n        if (typeMeta.primitive) {\n            this.primitives.add(name);\n        }\n        if (typeMeta.scalar) {\n            this.scalarTypes.add(name);\n        }\n    }\n\n    addType(name, TypeMeta) {\n        const typeMeta = new TypeMeta(this);\n\n        typeMeta.sanitize = (value, meta, i18n, path) => {\n            meta = { type: typeMeta.name, ...meta };\n            const opts = { rawValue: value, i18n, path, system: this };\n            const [isDone, sanitized] = this.beginSanitize(value, meta, opts);\n            return this.endSanitize(isDone ? sanitized : typeMeta._sanitize(value, meta, opts), meta, opts);\n        };\n\n        typeMeta.sanitize_ = async (value, meta, i18n, path) => {\n            meta = { type: typeMeta.name, ...meta };\n            const opts = { rawValue: value, i18n, path, system: this };\n            const [isDone, sanitized] = await this.beginSanitize(value, meta, opts);\n            return this.endSanitize(\n                isDone\n                    ? sanitized\n                    : typeMeta._sanitizeAsync\n                    ? await typeMeta._sanitizeAsync(value, meta, opts)\n                    : typeMeta._sanitize(value, meta, opts),\n                meta,\n                opts\n            );\n        };\n\n        this._addType(name, typeMeta);\n        this._addType(typeMeta.name, typeMeta);\n\n        typeMeta.alias?.forEach((a) => {\n            this._addType(a, typeMeta);\n        });\n    }\n\n    callType(method) {\n        return (value, typeInfo, i18n, fieldPath) => {\n            if (!this.primitives.has(typeInfo.type)) {\n                throw new InvalidArgument(`Unsupported primitive type: \"${typeInfo.type}\".`);\n            }\n\n            const typeObject = this.types[typeInfo.type];            \n            return typeObject[method](value, typeInfo, i18n, fieldPath);\n        };\n    }\n\n    safeJsonStringify(value) {\n        const bigintWriter = this.plugins['bigintWriter'];\n        if (bigintWriter) {\n            const replacer = (_, value) => (typeof value === 'bigint' ? bigintWriter(value) : value);\n\n            return JSON.stringify(value, replacer);\n        }\n\n        return JSON.stringify(value);\n    }\n\n    getStringifier() {\n        const bigintWriter = this.plugins['bigintWriter'];\n        if (bigintWriter) {\n            return (value) => (typeof value === 'bigint' ? bigintWriter(value) : value.toString());\n        }\n\n        return null;\n    }\n\n    beginSanitize(value, meta, opts) {\n        if (value == null) {\n            if (meta.default != null) {\n                return [true, meta.default];\n            } else if (meta.optional) {\n                return [true, null];\n            }\n\n            throw new ValidationError('Value ' + (opts.path ? `of \"${opts.path}\" ` : '') + 'is required.', {\n                value,\n                meta,\n                ...opts,\n            });\n        }\n\n        if (meta.rawValue) return [true, value];\n\n        // more prerequisites here ...\n        if (this.plugins.preProcess) {\n            return this.plugins.preProcess(value, meta, opts);\n        }\n\n        return [false];\n    }\n\n    endSanitize(value, meta, opts) {\n        if (this.scalarTypes.has(meta.type)) {\n            this.verifyEnum(value, meta, opts);\n        }\n\n        if (this.plugins.postProcess) {\n            return this.plugins.postProcess(value, meta, opts);\n        }\n\n        return value;\n    }\n\n    verifyEnum(value, meta, opts) {\n        if (meta.enum && !meta.enum.includes(value)) {\n            throw new ValidationError('Invalid enum value.', {\n                value,\n                meta,\n                ...opts,\n            });\n        }\n    }\n}\n\nconst defaultTypeSystem = new TypeSystem();\n\nexport const addType = (name, TypeMeta) => {\n    defaultTypeSystem.addType(name, TypeMeta);\n    defaultTypeClasses.push({ name, TypeMeta });\n};\n\nexport const addPlugin = (name, plugin) => {\n    defaultTypeSystem.addPlugin(name, plugin);\n    defaultPlugins.push({ name, plugin });\n};\n\nexport const createTypeSystem = (emptySystem) => {\n    return emptySystem ? new TypeSystem() : TypeSystem.fromDefault();\n};\n\nexport const Types = defaultTypeSystem.types;\n\n// compatibility\nTypes.sanitize = defaultTypeSystem.sanitize.bind(defaultTypeSystem);\nTypes.sanitize_ = defaultTypeSystem.sanitize_.bind(defaultTypeSystem);\nTypes.serialize = defaultTypeSystem.serialize.bind(defaultTypeSystem);\nTypes.primitives = defaultTypeSystem.primitives;\n\nexport default defaultTypeSystem;\n"],"names":["TypeSystem","addType","addPlugin","createTypeSystem","Types","counter","defaultTypeClasses","defaultPlugins","fromDefault","ts","forEach","name","TypeMeta","plugin","plugins","removePlugin","_addType","typeMeta","types","ApplicationError","primitive","primitives","add","scalar","scalarTypes","sanitize","value","meta","i18n","path","type","opts","rawValue","system","isDone","sanitized","beginSanitize","endSanitize","_sanitize","sanitize_","_sanitizeAsync","alias","a","callType","method","typeInfo","fieldPath","has","InvalidArgument","typeObject","safeJsonStringify","bigintWriter","replacer","_","JSON","stringify","getStringifier","toString","default","optional","ValidationError","preProcess","verifyEnum","postProcess","enum","includes","constructor","Set","serialize","_counter","defaultTypeSystem","push","emptySystem","bind"],"mappings":"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"}